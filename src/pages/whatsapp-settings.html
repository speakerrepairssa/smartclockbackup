<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Setup - AI Clock</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 2rem;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .step-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .step-number {
      background: #25D366;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .step-title {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .step-desc {
      color: #666;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #2c3e50;
      font-weight: 600;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #25D366;
    }

    .form-group small {
      color: #666;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: block;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 1rem;
    }

    .btn-primary {
      background: #25D366;
      color: white;
    }

    .btn-primary:hover {
      background: #128C7E;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .status {
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .business-info {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .info-item {
      text-align: center;
    }

    .info-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.25rem;
    }

    .info-value {
      font-weight: 600;
      color: #2c3e50;
    }

    .template-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .template-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .template-lang {
      font-size: 0.85rem;
      color: #666;
    }

    .progress {
      text-align: center;
      margin: 2rem 0;
    }

    .progress-bar {
      background: #e9ecef;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      background: #25D366;
      height: 100%;
      transition: width 0.3s ease;
    }

    .back-btn {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <a href="business-dashboard.html" class="back-btn">‚Üê Dashboard</a>
  
  <div class="container">
    <div class="header">
      <h1>üì± WhatsApp Setup</h1>
      <p>Connect your Meta WhatsApp Business in 3 simple steps</p>
    </div>

    <!-- Step 1: Enter Token -->
    <div class="card step active" id="step1">
      <div class="step-header">
        <div class="step-number">1</div>
        <div class="step-title">Connect Your WhatsApp Business API</div>
        <div class="step-desc">Enter your Meta WhatsApp credentials to connect</div>
      </div>

      <form id="tokenForm">
        <div class="form-group">
          <label>Access Token</label>
          <input type="password" id="accessToken" placeholder="Your access token from Meta" required>
          <small>From Meta Developer Console ‚Üí Your App ‚Üí System Users</small>
        </div>

        <div class="form-group">
          <label>Phone Number ID</label>
          <input type="text" id="phoneNumberId" placeholder="e.g., 104235266075141" required>
          <small>From WhatsApp ‚Üí API Setup ‚Üí Phone Number ID</small>
        </div>

        <div class="form-group">
          <label>WhatsApp Business Account ID</label>
          <input type="text" id="businessAccountId" placeholder="e.g., 107739957151545" required>
          <small>From WhatsApp ‚Üí API Setup ‚Üí WhatsApp Business Account ID</small>
        </div>

        <div class="status" id="step1Status"></div>

        <button type="submit" class="btn btn-primary">‚úÖ Connect & Save</button>
      </form>
    </div>

    <!-- Step 2: Select Business & Phone -->
    <div class="card step" id="step2">
      <div class="step-header">
        <div class="step-number">2</div>
        <div class="step-title">Select Your Business Account</div>
        <div class="step-desc">Choose which WhatsApp Business account to use</div>
      </div>

      <div class="form-group">
        <label>Business Account</label>
        <select id="businessSelect" required>
          <option value="">Loading...</option>
        </select>
      </div>

      <div class="business-info" id="businessInfo" style="display: none;">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Business Name</div>
            <div class="info-value" id="businessName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Phone Number</div>
            <div class="info-value" id="phoneNumber">-</div>
          </div>
        </div>
      </div>

      <div class="status" id="step2Status"></div>

      <button type="button" class="btn btn-primary" id="selectBusiness" disabled>Continue ‚Üí</button>
    </div>

    <!-- Step 3: Map Templates -->
    <div class="card step" id="step3">
      <div class="step-header">
        <div class="step-number">‚úÖ</div>
        <div class="step-title">WhatsApp Connected & Ready</div>
        <div class="step-desc">Create automation cards to send WhatsApp messages</div>
      </div>

      <!-- Current Settings Display -->
      <div id="currentSettings" style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #4caf50;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">üì± WhatsApp API Connected</h4>
            <div style="font-size: 0.9rem; color: #666;">
              <span id="displayPhoneNumber">-</span>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" id="editSettings" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin: 0;">‚úèÔ∏è Edit</button>
        </div>
      </div>

      <!-- Automation Cards Section -->
      <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div>
            <h4 style="margin: 0 0 0.3rem 0;">ü§ñ Automation Cards</h4>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Automated WhatsApp messages triggered by events</p>
          </div>
          <button type="button" class="btn btn-primary" onclick="openCreateCardModal()" style="margin: 0; padding: 0.6rem 1.2rem;">
            ‚ûï Create Card
          </button>
        </div>
        
        <div id="configuredMappings">
          <div id="mappingsList"></div>
          <div id="noCardsMessage" style="text-align: center; padding: 3rem 1rem; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd; display: none;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì±</div>
            <h4 style="color: #666; margin-bottom: 0.5rem;">No Automation Cards Yet</h4>
            <p style="color: #999; font-size: 0.9rem;">Click "Create Card" to set up your first automated WhatsApp message</p>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-secondary" onclick="window.location.href='business-dashboard.html'" style="width: 100%;">‚Üê Back to Dashboard</button>
    </div>

    <!-- Old template list - keeping for reference but hidden -->
    <div id="templatesList" style="display: none;">
      <div class="loading">Loading your templates...</div>
    </div>

    <!-- Template Details Preview (hidden) -->
    <div id="templateDetails" style="display: none; background: #f0f7ff; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #2196F3;">
      <h4 style="margin: 0 0 1rem 0; color: #1976D2;">üìã Template Details</h4>
      <div id="templateDetailsContent"></div>
      
      <!-- Add Mapping Button -->
      <button type="button" class="btn btn-primary" id="addMappingBtn" onclick="openMappingModal()" style="margin-top: 1rem;">
        ‚ûï Create New Automation Card
      </button>
    </div>

    <!-- Template Mapping Modal -->
    <div id="mappingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 2rem auto; background: white; border-radius: 12px; padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">üîó Template Trigger & Mapping</h3>
            <button onclick="closeMappingModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
          </div>

          <div class="form-group">
            <label><strong>Template:</strong></label>
            <div id="mappingTemplateName" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;"></div>
          </div>

          <div class="form-group">
            <label><strong>üìù Automation Name:</strong></label>
            <input type="text" id="automationCardName" placeholder="e.g., 'Daily payroll notification' or 'Clock-out reminder'" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px;">
            <small style="color: #666; font-style: italic; display: block; margin-top: 0.3rem;">Give this automation a descriptive name to identify it easily</small>
          </div>

          <div class="form-group">
            <label><strong>Trigger Event:</strong></label>
            <select id="triggerEvent" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
              <option value="">Select when to send this message...</option>
              <option value="clock-in">üïê Employee Clock In</option>
              <option value="clock-out">üïê Employee Clock Out</option>
              <option value="late-arrival">‚è∞ Late Arrival (15+ min late)</option>
              <option value="early-departure">üèÉ Early Departure</option>
              <option value="forgot-clockout">‚ö†Ô∏è Forgot to Clock Out</option>
              <option value="daily-summary">üìä Daily Summary (end of day)</option>
              <option value="weekly-summary">üìÖ Weekly Summary (Friday)</option>
              <option value="monthly-summary">üìÜ Monthly Summary (last day)</option>
              <option value="manual">‚úã Manual Send Only</option>
            </select>
          </div>

          <div class="form-group">
            <label><strong>Send To:</strong></label>
            <select id="recipientType" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
              <option value="employee">üë§ Employee (who triggered the event)</option>
              <option value="manager">üëî Manager/Supervisor</option>
              <option value="admin">üîë Business Admin</option>
              <option value="custom">üì± Custom Phone Number</option>
            </select>
          </div>

          <div id="parameterMappings" style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">üìù Parameter Mapping</h4>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Map template parameters to assessment cache data:</p>
            <div id="mappingFields"></div>
          </div>

          <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="button" class="btn btn-primary" onclick="saveMappingConfig()" style="flex: 1;">üíæ Save Mapping</button>
            <button type="button" class="btn btn-secondary" onclick="closeMappingModal()" style="flex: 1;">Cancel</button>
          </div>

          <div class="status" id="mappingStatus"></div>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 33%"></div>
      </div>
      <div id="progressText">Step 1 of 3</div>
    </div>
  </div>

  <script type="module">
    import { doc, setDoc, getDoc, collection, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from '../config/firebase.js';
    import authService from '../modules/auth/auth.service.js';

    let businessId = null;
    let accessToken = '';
    let selectedBusiness = null;
    let templates = [];
    let currentEditingCardId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      if (!authService.isAuthenticated() || authService.getUserRole() !== "business") {
        window.location.href = '/pages/login.html';
        return;
      }
      businessId = authService.getBusinessId();
      setupEventListeners();
      await checkExistingSetup();
    });

    async function checkExistingSetup() {
      try {
        const settingsRef = doc(db, "businesses", businessId, "settings", "whatsapp");
        const settingsDoc = await getDoc(settingsRef);
        
        if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          console.log('üì¶ Existing settings found:', settings);
          
          if (settings.accessToken && settings.phoneNumberId && settings.businessAccountId) {
            // Restore the selectedBusiness object
            accessToken = settings.accessToken;
            
            // Fetch templates again to get full data
            console.log('üîÑ Reloading templates from API...');
            const templatesResponse = await fetch(`https://graph.facebook.com/v17.0/${settings.businessAccountId}/message_templates`, {
              headers: { 'Authorization': `Bearer ${settings.accessToken}` }
            });
            
            let templates = [];
            if (templatesResponse.ok) {
              const templatesData = await templatesResponse.json();
              templates = templatesData.data || [];
              console.log('‚úÖ Templates reloaded:', templates.length);
            }
            
            // Reconstruct selectedBusiness
            selectedBusiness = {
              accessToken: settings.accessToken,
              phoneNumberId: settings.phoneNumberId,
              businessAccountId: settings.businessAccountId,
              phoneNumber: settings.phoneNumber,
              businessName: settings.businessName || 'WhatsApp Business',
              templates: templates
            };
            
            console.log('‚úÖ selectedBusiness restored:', selectedBusiness);
            
            // Show step 3 and load the display
            showStep(3);
            updateProgress(100, "Setup Complete!");
            loadSuccessDisplay();
            
            // Setup edit button listener after step 3 is shown
            setTimeout(() => {
              const editBtn = document.getElementById('editSettings');
              if (editBtn) {
                editBtn.addEventListener('click', editSettings);
              }
            }, 100);
          }
        }
      } catch (error) {
        console.log('No existing setup found or error loading:', error);
      }
    }

    function setupEventListeners() {
      document.getElementById('tokenForm').addEventListener('submit', handleTokenSubmit);
      
      // Edit settings button (will be available after setup)
      const editBtn = document.getElementById('editSettings');
      if (editBtn) {
        editBtn.addEventListener('click', editSettings);
      }
    }

    function editSettings() {
      // Go back to step 1 and clear the form for re-entry
      showStep(1);
      updateProgress(33, "Step 1 of 3");
      
      // Pre-fill current values if they exist
      if (selectedBusiness) {
        document.getElementById('phoneNumberId').value = selectedBusiness.phoneNumberId || '';
        document.getElementById('businessAccountId').value = selectedBusiness.businessAccountId || '';
        // Don't pre-fill access token for security
      }
      
      showStatus('step1Status', '‚ÑπÔ∏è Update your WhatsApp API credentials below', 'success');
    }

    async function handleTokenSubmit(e) {
      e.preventDefault();
      console.log('üîê handleTokenSubmit called');
      
      accessToken = document.getElementById('accessToken').value;
      const phoneNumberId = document.getElementById('phoneNumberId').value;
      const businessAccountId = document.getElementById('businessAccountId').value;
      
      console.log('   Access token length:', accessToken?.length);
      console.log('   Phone Number ID:', phoneNumberId);
      console.log('   Business Account ID:', businessAccountId);
      
      if (!accessToken || !phoneNumberId || !businessAccountId) {
        showStatus('step1Status', 'Please fill in all fields', 'error');
        return;
      }

      showStatus('step1Status', 'üîÑ Testing connection...', 'success');
      
      try {
        // Test connection by getting phone number info
        const response = await fetch(`https://graph.facebook.com/v18.0/${phoneNumberId}`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'Invalid credentials. Please check your values.');
        }

        const phoneData = await response.json();
        
        // Get templates using the correct endpoint - should use phone number ID, not business account ID
        showStatus('step1Status', 'üîÑ Loading templates...', 'success');
        console.log('Fetching templates using phone number ID:', phoneNumberId);
        
        // Try multiple endpoints to find templates
        let templatesResponse;
        let templates = [];
        
        // First try: Use business account ID (standard way)
        templatesResponse = await fetch(`https://graph.facebook.com/v17.0/${businessAccountId}/message_templates`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        console.log('Business Account templates API response:', templatesResponse.status);
        
        if (templatesResponse.ok) {
          const templatesData = await templatesResponse.json();
          console.log('Business Account templates data:', templatesData);
          templates = templatesData.data || [];
        }
        
        // If no templates from business account, try with phone number ID
        if (!templates.length) {
          console.log('Trying templates with phone number ID...');
          templatesResponse = await fetch(`https://graph.facebook.com/v17.0/${phoneNumberId}/message_templates`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          
          console.log('Phone Number templates API response:', templatesResponse.status);
          
          if (templatesResponse.ok) {
            const templatesData = await templatesResponse.json();
            console.log('Phone Number templates data:', templatesData);
            templates = templatesData.data || [];
          }
        }
        
        // If still no templates, try the 'me' endpoint
        if (!templates.length) {
          console.log('Trying templates with /me endpoint...');
          templatesResponse = await fetch(`https://graph.facebook.com/v17.0/me/message_templates`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          
          console.log('Me templates API response:', templatesResponse.status);
          
          if (templatesResponse.ok) {
            const templatesData = await templatesResponse.json();
            console.log('Me templates data:', templatesData);
            templates = templatesData.data || [];
          }
        }
        
        console.log('Final templates array:', templates.length, templates);
        
        // Don't filter by status initially - let's see all templates
        if (templates.length > 0) {
          console.log('All templates found:', templates.length);
          const approvedTemplates = templates.filter(t => t.status === 'APPROVED');
          console.log('Approved templates:', approvedTemplates.length, approvedTemplates);
          
          // Use all templates for now to see what we have
          templates = templates;
        } else {
          console.error('No templates found from any endpoint');
          // Don't throw error, just continue with empty array
        }

        // Save configuration
        selectedBusiness = {
          accessToken,
          phoneNumberId,
          businessAccountId,
          phoneNumber: phoneData.display_phone_number || phoneData.verified_name,
          businessName: 'WhatsApp Business',
          templates
        };

        // Save to Firebase (clean data to avoid nested arrays)
        const settingsRef = doc(db, "businesses", businessId, "settings", "whatsapp");
        
        // Clean templates data for Firestore (remove nested arrays)
        const cleanTemplates = selectedBusiness.templates.map(template => ({
          id: template.id,
          name: template.name,
          category: template.category,
          language: template.language,
          status: template.status,
          components: template.components ? template.components.length : 0 // Just store count
        }));
        
        const cleanSettings = {
          accessToken: selectedBusiness.accessToken,
          phoneNumberId: selectedBusiness.phoneNumberId,
          businessAccountId: selectedBusiness.businessAccountId,
          phoneNumber: selectedBusiness.phoneNumber,
          businessName: selectedBusiness.businessName,
          templateCount: cleanTemplates.length,
          templateNames: cleanTemplates.map(t => t.name), // Simple array of names
          enabled: true,
          setupDate: new Date().toISOString()
        };
        
        await setDoc(settingsRef, cleanSettings);

        console.log('‚úÖ Settings saved to Firebase');
        console.log('selectedBusiness object:', selectedBusiness);
        console.log('selectedBusiness.templates:', selectedBusiness.templates);
        
        showStatus('step1Status', '‚úÖ Connected successfully!', 'success');
        
        // Go directly to step 3 (skip step 2 since we're using direct credentials)
        showStep(3);
        updateProgress(100, "Setup Complete!");
        
        // Load the success display with templates
        setTimeout(() => {
          loadSuccessDisplay();
        }, 100);

      } catch (error) {
        console.error('Connection error:', error);
        showStatus('step1Status', `‚ùå ${error.message}`, 'error');
      }
    }

    // Removed complex business selection - simplified to direct credential input

    // Removed - now using direct credential input instead of business selection

    async function handleBusinessConfirm() {
      if (!selectedBusiness) return;

      try {
        showStatus('step2Status', 'üîÑ Setting up templates...', 'success');

        // Get templates
        const templatesResponse = await fetch(`https://graph.facebook.com/v18.0/${selectedBusiness.id}/message_templates`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (templatesResponse.ok) {
          const templatesData = await templatesResponse.json();
          templates = templatesData.data?.filter(t => t.status === 'APPROVED') || [];
        }

        // Save to Firebase
        const whatsappConfig = {
          accessToken: accessToken,
          businessAccountId: selectedBusiness.id,
          businessName: selectedBusiness.name,
          phoneNumberId: selectedBusiness.phoneId,
          phoneNumber: selectedBusiness.phoneNumber,
          templates: templates,
          enabled: true,
          setupDate: new Date().toISOString()
        };

        const settingsRef = doc(db, "businesses", businessId, "settings", "whatsapp");
        await setDoc(settingsRef, whatsappConfig);

        showStep(3);
        updateProgress(100, "Setup Complete!");
        loadTemplatesDisplay();

      } catch (error) {
        showStatus('step2Status', `‚ùå Setup failed: ${error.message}`, 'error');
      }
    }

    function loadTemplatesDisplay() {
      const container = document.getElementById('templatesList');
      
      if (templates.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No approved templates found. Create templates in Meta Business Manager.</p>';
        return;
      }

      let html = '<h4 style="margin-bottom: 1rem;">Your WhatsApp Templates:</h4>';
      
      templates.forEach(template => {
        html += `
          <div class="template-item">
            <div>
              <div class="template-name">${template.name}</div>
              <div class="template-lang">${template.language} ‚Ä¢ ${template.category}</div>
            </div>
            <button class="btn btn-secondary" onclick="testTemplate('${template.name}')">Test</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    window.testTemplate = function(templateName) {
      const phone = document.getElementById('testPhone').value;
      if (!phone) {
        alert('Please enter your phone number first');
        document.getElementById('testPhone').focus();
        return;
      }
      sendTestMessage(templateName);
    };

    async function sendTestMessage(specificTemplate = null) {
      // Get phone and template selection
      const phone = document.getElementById('testPhone').value;
      const templateSelect = document.getElementById('templateSelect');
      const selectedTemplate = templateSelect ? templateSelect.value : null;
      
      console.log('üì§ sendTestMessage called');
      console.log('   Phone:', phone);
      console.log('   specificTemplate param:', specificTemplate);
      console.log('   selectedTemplate from dropdown:', selectedTemplate);
      
      if (!phone) {
        showStatus('step3Status', 'Please enter your phone number first', 'error');
        return;
      }

      // Use specificTemplate if provided, otherwise use dropdown selection
      const templateToTest = (typeof specificTemplate === 'string') ? specificTemplate : selectedTemplate;
      
      console.log('   templateToTest:', templateToTest);

      if (!templateToTest) {
        showStatus('step3Status', 'Please select a template from the dropdown', 'error');
        return;
      }

      // Check if we have templates
      if (!selectedBusiness || !selectedBusiness.templates || selectedBusiness.templates.length === 0) {
        showStatus('step3Status', 'No templates available. Please create approved templates in your Meta Business account first.', 'error');
        return;
      }

      try {
        showStatus('step3Status', 'üì± Sending test message...', 'success');

        const template = selectedBusiness.templates.find(t => t.name === templateToTest);
        
        console.log('   Found template:', template);
        
        if (!template) {
          throw new Error(`Template "${templateToTest}" not found`);
        }

        // Build template message with parameters
        const messageData = {
          messaging_product: "whatsapp",
          to: phone.replace(/\D/g, ''),
          type: "template",
          template: {
            name: templateToTest,
            language: { code: template.language || 'en' }
          }
        };

        // Extract parameters from template components
        if (template.components && template.components.length > 0) {
          const bodyComponent = template.components.find(c => c.type === 'BODY');
          if (bodyComponent && bodyComponent.example && bodyComponent.example.body_text && bodyComponent.example.body_text[0]) {
            const exampleParams = bodyComponent.example.body_text[0];
            messageData.template.components = [
              {
                type: "body",
                parameters: exampleParams.map(param => ({
                  type: "text",
                  text: param
                }))
              }
            ];
            console.log('   Added parameters:', exampleParams);
          }
        }

        const response = await fetch(`https://graph.facebook.com/v18.0/${selectedBusiness.phoneNumberId}/messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${selectedBusiness.accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(messageData)
        });

        if (response.ok) {
          const result = await response.json();
          showStatus('step3Status', `‚úÖ Test message sent successfully! Check ${phone}`, 'success');
        } else {
          const error = await response.json();
          throw new Error(error.error?.message || 'Failed to send message');
        }

      } catch (error) {
        console.error('Test message error:', error);
        showStatus('step3Status', `‚ùå Test failed: ${error.message}`, 'error');
      }
    }

    function finishSetup() {
      window.location.href = 'business-dashboard.html';
    }

    window.showTemplateDetails = function() {
      const templateSelect = document.getElementById('templateSelect');
      const selectedTemplateName = templateSelect.value;
      const detailsDiv = document.getElementById('templateDetails');
      const contentDiv = document.getElementById('templateDetailsContent');
      
      // Save selected template to localStorage
      if (selectedTemplateName && businessId) {
        localStorage.setItem(`whatsapp_selected_template_${businessId}`, selectedTemplateName);
      }
      
      if (!selectedTemplateName) {
        detailsDiv.style.display = 'none';
        return;
      }
      
      const template = selectedBusiness.templates.find(t => t.name === selectedTemplateName);
      
      if (!template) {
        detailsDiv.style.display = 'none';
        return;
      }
      
      console.log('Selected template:', template);
      
      let html = `
        <div style="margin-bottom: 1rem;">
          <strong>Name:</strong> ${template.name}<br>
          <strong>Category:</strong> ${template.category || 'N/A'}<br>
          <strong>Language:</strong> ${template.language}<br>
          <strong>Status:</strong> <span style="color: ${template.status === 'APPROVED' ? '#25D366' : '#ffa500'}; font-weight: bold;">${template.status}</span>
        </div>
      `;
      
      if (template.components && template.components.length > 0) {
        html += '<div style="margin-top: 1rem;"><h5 style="margin-bottom: 0.5rem;">üìù Components & Parameters:</h5>';
        
        template.components.forEach((comp, idx) => {
          html += `<div style="background: white; padding: 1rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #ddd;">`;
          html += `<strong>${comp.type.toUpperCase()}</strong>`;
          
          if (comp.text) {
            html += `<pre style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; white-space: pre-wrap; font-size: 0.9rem;">${comp.text}</pre>`;
          }
          
          if (comp.example && comp.example.body_text) {
            html += `<div style="margin-top: 0.5rem;"><strong>Parameters Required:</strong></div>`;
            html += `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">`;
            comp.example.body_text[0].forEach((param, i) => {
              html += `<li><code style="background: #ffe0b2; padding: 2px 6px; border-radius: 3px;">{{${i + 1}}}</code> = "${param}" <em style="color: #666;">(example)</em></li>`;
            });
            html += `</ul>`;
          }
          
          html += `</div>`;
        });
        
        html += '</div>';
      } else {
        html += '<p style="color: #666; font-style: italic;">No parameters required for this template.</p>';
      }
      
      // Show mapping suggestion
      html += `
        <div style="margin-top: 1rem; padding: 1rem; background: #fff9e6; border-left: 4px solid #ffc107; border-radius: 4px;">
          <strong>üí° Integration Tip:</strong><br>
          <small>You can map these parameters to your employee data: name, hours worked, pay amount, etc.</small>
        </div>
      `;
      
      contentDiv.innerHTML = html;
      detailsDiv.style.display = 'block';
    };

    // Assessment cache field options for mapping
    const assessmentFields = [
      { value: 'employeeName', label: 'Employee Name' },
      { value: 'employeeId', label: 'Employee ID' },
      { value: 'date', label: 'Date' },
      { value: 'requiredHours', label: 'Required Hours' },
      { value: 'hoursWorked', label: 'Hours Worked' },
      { value: 'overtimeHours', label: 'Overtime Hours' },
      { value: 'lateMinutes', label: 'Late Minutes' },
      { value: 'earlyDepartureMinutes', label: 'Early Departure Minutes' },
      { value: 'absences', label: 'Absences Count' },
      { value: 'totalPay', label: 'Total Pay' },
      { value: 'basePay', label: 'Base Pay' },
      { value: 'overtimePay', label: 'Overtime Pay' },
      { value: 'deductions', label: 'Deductions' },
      { value: 'clockInTime', label: 'Clock In Time' },
      { value: 'clockOutTime', label: 'Clock Out Time' },
      { value: 'phoneNumber', label: 'Employee Phone Number' },
      { value: 'custom', label: 'Custom Value (enter manually)' }
    ];

    let currentMappingTemplate = null;

    // Open modal to create new automation card - first select template
    window.openCreateCardModal = function() {
      console.log('üéØ openCreateCardModal called');
      console.log('   selectedBusiness:', selectedBusiness);
      
      // Reset editing state
      currentEditingCardId = null;
      
      // Check if we have templates
      if (!selectedBusiness || !selectedBusiness.templates || selectedBusiness.templates.length === 0) {
        console.error('‚ùå No templates available');
        alert('No templates available. Please check your WhatsApp connection.');
        return;
      }
      
      console.log('   Templates available:', selectedBusiness.templates.length);
      
      // Show template selector
      const approvedTemplates = selectedBusiness.templates.filter(t => t.status === 'APPROVED');
      console.log('   Approved templates:', approvedTemplates.length);
      
      if (approvedTemplates.length === 0) {
        alert('No approved templates found. Please create and approve templates in Meta Business Manager first.');
        return;
      }
      
      const templateOptions = approvedTemplates
        .map(t => `<option value="${t.name}">${t.name} (${t.language})</option>`)
        .join('');
      
      console.log('   Opening modal with', approvedTemplates.length, 'templates');
      
      // Ask user to select template first
      const modal = document.getElementById('mappingModal');
      if (!modal) {
        console.error('‚ùå Modal element not found');
        alert('Error: Modal not found. Please refresh the page.');
        return;
      }
      
      const modalContent = modal.querySelector('div > div');
      if (!modalContent) {
        console.error('‚ùå Modal content element not found');
        alert('Error: Modal content not found. Please refresh the page.');
        return;
      }
      
      console.log('   Setting modal content...');
      
      // Temporarily replace modal content with template selector
      modalContent.innerHTML = `
        <div style="text-align: center;">
          <h3 style="margin-bottom: 1.5rem;">\ud83c\udfaf Select WhatsApp Template</h3>
          <p style="color: #666; margin-bottom: 2rem;">Choose which template to use for this automation card</p>
          
          <select id="templateSelectorModal" style="width: 100%; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 2rem;">
            <option value="">-- Choose a template --</option>
            ${templateOptions}
          </select>
          
          <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-primary" onclick="proceedWithTemplate()" style="flex: 1;">Next \u2192</button>
            <button type="button" class="btn btn-secondary" onclick="closeMappingModal()" style="flex: 1;">Cancel</button>
          </div>
        </div>
      `;
      
      console.log('   Modal innerHTML set, length:', modalContent.innerHTML.length);
      console.log('   Current modal display:', modal.style.display);
      modal.style.display = 'block';
      console.log('   After setting - modal display:', modal.style.display);
      console.log('   Modal visible:', modal.offsetHeight > 0);
    };
    
    // Proceed to configure the selected template
    window.proceedWithTemplate = function() {
      const select = document.getElementById('templateSelectorModal');
      const templateName = select.value;
      
      if (!templateName) {
        alert('Please select a template');
        return;
      }
      
      console.log('üìã Proceeding with template:', templateName);
      
      // Find the template
      const template = selectedBusiness.templates.find(t => t.name === templateName);
      if (!template) {
        alert('Template not found');
        return;
      }
      
      currentMappingTemplate = template;
      currentEditingCardId = null; // Creating new card
      
      // Restore the full modal form structure
      const modal = document.getElementById('mappingModal');
      const modalContent = modal.querySelector('div > div');
      
      // Build the full modal form HTML
      modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h3 style="margin: 0;">\ud83d\udd17 Configure Automation Card</h3>
          <button onclick="closeMappingModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">\u00d7</button>
        </div>

        <div class="form-group">
          <label><strong>Template:</strong></label>
          <div id="mappingTemplateName" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">${template.name}</div>
        </div>

        <div class="form-group">
          <label><strong>\ud83d\udcdd Automation Name:</strong></label>
          <input type="text" id="automationCardName" placeholder="e.g., 'Daily payroll notification' or 'Clock-out reminder'" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px;">
          <small style="color: #666; font-style: italic; display: block; margin-top: 0.3rem;">Give this automation a descriptive name to identify it easily</small>
        </div>

        <div class="form-group">
          <label><strong>Trigger Event:</strong></label>
          <select id="triggerEvent" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
            <option value="">Select when to send this message...</option>
            <option value="clock-in">\ud83d\udd50 Employee Clock In</option>
            <option value="clock-out">\ud83d\udd50 Employee Clock Out</option>
            <option value="late-arrival">\u23f0 Late Arrival (15+ min late)</option>
            <option value="early-departure">\ud83c\udfc3 Early Departure</option>
            <option value="forgot-clockout">\u26a0\ufe0f Forgot to Clock Out</option>
            <option value="daily-summary">\ud83d\udcca Daily Summary (end of day)</option>
            <option value="weekly-summary">\ud83d\udcc5 Weekly Summary (Friday)</option>
            <option value="monthly-summary">\ud83d\udcc6 Monthly Summary (last day)</option>
            <option value="manual">\u270b Manual Send Only</option>
          </select>
        </div>

        <div class="form-group">
          <label><strong>Send To:</strong></label>
          <select id="recipientType" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
            <option value="employee">\ud83d\udc64 Employee (who triggered the event)</option>
            <option value="manager">\ud83d\udc54 Manager/Supervisor</option>
            <option value="admin">\ud83d\udd11 Business Admin</option>
            <option value="custom">\ud83d\udcf1 Custom Phone Number</option>
          </select>
        </div>

        <div id="parameterMappings" style="margin-top: 1.5rem;">
          <h4 style="margin-bottom: 1rem;">\ud83d\udcdd Parameter Mapping</h4>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Map template parameters to assessment cache data:</p>
          <div id="mappingFields"></div>
        </div>

        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
          <button type="button" class="btn btn-primary" onclick="saveMappingConfig()" style="flex: 1;">\ud83d\udcbe Save Card</button>
          <button type="button" class="btn btn-secondary" onclick="closeMappingModal()" style="flex: 1;">Cancel</button>
        </div>

        <div class="status" id="mappingStatus"></div>
      `;
      
      // Now populate the parameter fields
      const mappingFieldsDiv = document.getElementById('mappingFields');
      let fieldsHTML = '';
      
      // Find body component with parameters
      const bodyComp = template.components?.find(c => c.type === 'BODY');
      const paramCount = bodyComp?.example?.body_text?.[0]?.length || 0;
      
      console.log('   Parameters to map:', paramCount);
      
      if (paramCount > 0) {
        for (let i = 0; i < paramCount; i++) {
          const exampleValue = bodyComp.example.body_text[0][i];
          fieldsHTML += `
            <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid #ddd;">
              <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
                Parameter {{${i + 1}}} <span style="color: #666; font-weight: normal;">(example: "${exampleValue}")</span>
              </label>
              <select class="param-mapping" data-param-index="${i}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;" onchange="toggleCustomInput(${i})">
                <option value="">Select data source...</option>
                ${assessmentFields.map(f => `<option value="${f.value}">${f.label}</option>`).join('')}
              </select>
              <input type="text" id="customValue${i}" placeholder="Enter custom value" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; display: none;">
            </div>
          `;
        }
      } else {
        fieldsHTML = '<p style="color: #666; font-style: italic;">This template has no parameters to map.</p>';
      }
      
      mappingFieldsDiv.innerHTML = fieldsHTML;
      
      console.log('\u2705 Modal form ready');
    };

    window.openMappingModal = function(templateName = null) {
      // Reset editing state if starting fresh
      if (!templateName) {
        currentEditingCardId = null;
      }
      
      const templateSelect = document.getElementById('templateSelect');
      const selectedTemplateName = templateName || templateSelect.value;
      
      if (!selectedTemplateName) {
        alert('Please select a template first');
        return;
      }
      
      currentMappingTemplate = selectedBusiness.templates.find(t => t.name === selectedTemplateName);
      
      if (!currentMappingTemplate) return;
      
      // Set template name
      document.getElementById('mappingTemplateName').textContent = currentMappingTemplate.name;
      
      // Build parameter mapping fields
      const mappingFieldsDiv = document.getElementById('mappingFields');
      let fieldsHTML = '';
      
      // Find body component with parameters
      const bodyComp = currentMappingTemplate.components?.find(c => c.type === 'BODY');
      const paramCount = bodyComp?.example?.body_text?.[0]?.length || 0;
      
      if (paramCount > 0) {
        for (let i = 0; i < paramCount; i++) {
          const exampleValue = bodyComp.example.body_text[0][i];
          fieldsHTML += `
            <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid #ddd;">
              <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
                Parameter {{${i + 1}}} <span style="color: #666; font-weight: normal;">(example: "${exampleValue}")</span>
              </label>
              <select class="param-mapping" data-param-index="${i}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;" onchange="toggleCustomInput(${i})">
                <option value="">Select data source...</option>
                ${assessmentFields.map(f => `<option value="${f.value}">${f.label}</option>`).join('')}
              </select>
              <input type="text" id="customValue${i}" placeholder="Enter custom value" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; display: none;">
            </div>
          `;
        }
      } else {
        fieldsHTML = '<p style="color: #666; font-style: italic;">This template has no parameters to map.</p>';
      }
      
      mappingFieldsDiv.innerHTML = fieldsHTML;
      
      // Show modal
      document.getElementById('mappingModal').style.display = 'block';
      
      // Clear the form if creating new (not editing)
      if (!currentEditingCardId) {
        document.getElementById('automationCardName').value = '';
        document.getElementById('triggerEvent').value = '';
        document.getElementById('recipientType').value = '';
      }
    };

    window.toggleCustomInput = function(index) {
      const select = document.querySelector(`[data-param-index="${index}"]`);
      const customInput = document.getElementById(`customValue${index}`);
      
      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    };

    window.closeMappingModal = function() {
      document.getElementById('mappingModal').style.display = 'none';
    };

    async function loadExistingMapping(templateName) {
      try {
        const mappingRef = doc(db, "businesses", businessId, "whatsapp_mappings", templateName);
        const mappingDoc = await getDoc(mappingRef);
        
        if (mappingDoc.exists()) {
          const mapping = mappingDoc.data();
          document.getElementById('triggerEvent').value = mapping.trigger || '';
          document.getElementById('recipientType').value = mapping.recipient || '';
          
          // Load parameter mappings
          if (mapping.parameters) {
            mapping.parameters.forEach((param, i) => {
              const select = document.querySelector(`[data-param-index="${i}"]`);
              if (select) {
                select.value = param.source || '';
                if (param.source === 'custom') {
                  toggleCustomInput(i);
                  document.getElementById(`customValue${i}`).value = param.value || '';
                }
              }
            });
          }
        }
      } catch (error) {
        console.log('No existing mapping found');
      }
    }

    window.saveMappingConfig = async function() {
      console.log('üíæ saveMappingConfig called');
      
      const cardName = document.getElementById('automationCardName')?.value.trim();
      const triggerEvent = document.getElementById('triggerEvent')?.value;
      const recipientType = document.getElementById('recipientType')?.value;
      
      console.log('   Card name:', cardName);
      console.log('   Trigger:', triggerEvent);
      console.log('   Recipient:', recipientType);
      console.log('   Template:', currentMappingTemplate?.name);
      
      if (!cardName) {
        showStatus('mappingStatus', 'Please enter a name for this automation card', 'error');
        return;
      }
      
      if (!triggerEvent) {
        showStatus('mappingStatus', 'Please select a trigger event', 'error');
        return;
      }
      
      if (!recipientType) {
        showStatus('mappingStatus', 'Please select a recipient type', 'error');
        return;
      }
      
      // Collect parameter mappings
      const parameterMappings = [];
      const paramSelects = document.querySelectorAll('.param-mapping');
      
      console.log('   Collecting', paramSelects.length, 'parameters');
      
      paramSelects.forEach((select, i) => {
        const source = select.value;
        let value = source;
        
        if (source === 'custom') {
          value = document.getElementById(`customValue${i}`)?.value || '';
        }
        
        parameterMappings.push({
          parameterIndex: i + 1,
          source: source || 'none',
          value: value
        });
      });
      
      try {
        showStatus('mappingStatus', 'üíæ Saving automation card...', 'success');
        
        // Generate unique ID for this card
        const cardId = currentEditingCardId || `card_${Date.now()}`;
        
        console.log('   Saving card with ID:', cardId);
        
        const automationCard = {
          id: cardId,
          name: cardName,
          templateName: currentMappingTemplate.name,
          trigger: triggerEvent,
          recipient: recipientType,
          parameterMappings: parameterMappings,
          enabled: true,
          createdAt: currentEditingCardId ? undefined : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Remove undefined fields
        if (!automationCard.createdAt) delete automationCard.createdAt;
        
        console.log('   Card data:', automationCard);
        
        const cardRef = doc(db, "businesses", businessId, "whatsapp_automations", cardId);
        await setDoc(cardRef, automationCard);
        
        console.log('‚úÖ Card saved successfully!');
        showStatus('mappingStatus', '‚úÖ Automation card saved!', 'success');
        
        currentEditingCardId = null;
        
        setTimeout(() => {
          closeMappingModal();
          loadConfiguredMappings();
        }, 1000);
        
      } catch (error) {
        console.error('Error saving mapping:', error);
        showStatus('mappingStatus', `‚ùå ${error.message}`, 'error');
      }
    };

    async function loadConfiguredMappings() {
      try {
        const mappingsDiv = document.getElementById('configuredMappings');
        const listDiv = document.getElementById('mappingsList');
        const noCardsMsg = document.getElementById('noCardsMessage');
        
        // Get all automation cards
        const q = collection(db, "businesses", businessId, "whatsapp_automations");
        const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          listDiv.innerHTML = '';
          noCardsMsg.style.display = 'block';
          return;
        }
        
        noCardsMsg.style.display = 'none';
        
        const triggerLabels = {
          'clock-in': 'üïê Clock In',
          'clock-out': 'üïê Clock Out',
          'late-arrival': '‚è∞ Late Arrival',
          'daily-summary': 'üìä Daily Summary',
          'weekly-summary': 'üìÖ Weekly Summary',
          'monthly-summary': 'üìÜ Monthly Summary',
          'manual': '‚úã Manual'
        };
        
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">';
        
        querySnapshot.forEach(docSnap => {
          const card = docSnap.data();
          const statusColor = card.enabled ? '#25D366' : '#999';
          const statusIcon = card.enabled ? '‚úì' : '‚è∏';
          
          html += `
            <div style="background: white; padding: 1.2rem; border-radius: 12px; border: 2px solid ${statusColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 0.5rem 0; color: #333; font-size: 1.1rem;">${card.name}</h4>
                  <div style="background: #f0f7ff; padding: 0.4rem 0.6rem; border-radius: 6px; display: inline-block; font-size: 0.85rem; color: #0066cc; margin-bottom: 0.5rem;">
                    üì± ${card.templateName}
                  </div>
                </div>
                <span style="background: ${statusColor}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold;">${statusIcon}</span>
              </div>
              
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem; line-height: 1.6;">
                <div><strong>Trigger:</strong> ${triggerLabels[card.trigger] || card.trigger}</div>
                <div><strong>Send to:</strong> ${card.recipient}</div>
                <div><strong>Parameters:</strong> ${card.parameterMappings?.length || 0} mapped</div>
              </div>
              
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button onclick="editAutomationCard('${docSnap.id}')" style="flex: 1; padding: 0.5rem; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚úèÔ∏è Edit</button>
                <button onclick="toggleAutomationCard('${docSnap.id}', ${!card.enabled})" style="flex: 1; padding: 0.5rem; background: ${card.enabled ? '#ffa500' : '#25D366'}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">${card.enabled ? '‚è∏ Pause' : '‚ñ∂Ô∏è Enable'}</button>
                <button onclick="deleteAutomationCard('${docSnap.id}')" style="padding: 0.5rem 0.8rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        
        listDiv.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading mappings:', error);
      }
    }

    window.deleteAutomationCard = async function(cardId) {
      if (!confirm('Delete this automation card?')) return;
      
      try {
        const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const cardRef = doc(db, "businesses", businessId, "whatsapp_automations", cardId);
        await deleteDoc(cardRef);
        loadConfiguredMappings();
      } catch (error) {
        console.error('Error deleting card:', error);
        alert('Failed to delete automation card');
      }
    };
    
    window.toggleAutomationCard = async function(cardId, enableState) {
      try {
        const cardRef = doc(db, "businesses", businessId, "whatsapp_automations", cardId);
        await updateDoc(cardRef, { enabled: enableState, updatedAt: new Date().toISOString() });
        loadConfiguredMappings();
      } catch (error) {
        console.error('Error toggling card:', error);
        alert('Failed to update automation card');
      }
    };
    
    window.editAutomationCard = async function(cardId) {
      try {
        const cardRef = doc(db, "businesses", businessId, "whatsapp_automations", cardId);
        const cardDoc = await getDoc(cardRef);
        
        if (!cardDoc.exists()) return;
        
        const card = cardDoc.data();
        currentEditingCardId = cardId;
        currentMappingTemplate = selectedBusiness.templates.find(t => t.name === card.templateName);
        
        if (!currentMappingTemplate) {
          alert('Template not found');
          return;
        }
        
        // Open modal with this template
        openMappingModal(card.templateName);
        
        // Pre-fill form after a short delay to ensure modal is rendered
        setTimeout(() => {
          document.getElementById('automationCardName').value = card.name;
          document.getElementById('triggerEvent').value = card.trigger;
          document.getElementById('recipientType').value = card.recipient;
          
          // Pre-fill parameter mappings
          card.parameterMappings?.forEach((mapping, index) => {
            const select = document.querySelector(`[data-param-index="${index}"]`);
            if (select) {
              select.value = mapping.source;
              if (mapping.source === 'custom') {
                const customInput = document.getElementById(`customValue${index}`);
                if (customInput) {
                  customInput.style.display = 'block';
                  customInput.value = mapping.value;
                }
              }
            }
          });
        }, 100);
        
      } catch (error) {
        console.error('Error loading card for edit:', error);
        alert('Failed to load automation card');
      }
    };

    function showStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById(`step${stepNumber}`).classList.add('active');
    }

    function updateProgress(percentage, text) {
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = text;
    }

    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
      element.style.display = 'block';
    }

    function loadSuccessDisplay() {
      console.log('üîÑ loadSuccessDisplay called');
      
      // Check if selectedBusiness exists
      if (!selectedBusiness) {
        console.error('‚ùå selectedBusiness is null in loadSuccessDisplay');
        return;
      }
      
      console.log('‚úÖ loadSuccessDisplay - selectedBusiness:', selectedBusiness);
      
      // Display phone number only
      document.getElementById('displayPhoneNumber').textContent = selectedBusiness.phoneNumber || selectedBusiness.phoneNumberId || 'Connected';
      
      // Load automation cards
      loadConfiguredMappings();
    }
  </script>
</body>
