<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Dashboard - AiClock</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    .dashboard-wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 1rem;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebar-header {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 1rem;
    }

    .sidebar-menu button {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .sidebar-menu button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    .sidebar-menu button.active {
      background: rgba(255, 255, 255, 0.3);
      border-left: 3px solid white;
    }

    .sidebar-footer {
      position: absolute;
      bottom: 1rem;
      width: 180px;
    }

    .logout-btn {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255, 67, 67, 0.8);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 67, 67, 1);
    }

    /* Main Content */
    .main-content {
      margin-left: 200px;
      flex: 1;
      padding: 2rem;
    }

    .dashboard-header {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      flex-direction: column;
    }

    .header-title h1 {
      font-size: 1.8rem;
      color: #667eea;
      margin-bottom: 0.25rem;
    }

    .header-title p {
      color: #666;
      font-size: 0.95rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 2.5rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
    }

    .stat-subtext {
      color: #999;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    /* Modules Grid */
    .modules-section {
      margin-top: 2rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #333;
    }

    .section-description {
      color: #666;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1.5rem;
    }

    .module-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
    }

    .module-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .module-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .module-name {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .module-status {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
    }

    /* Views */
    .view-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .view-section.active {
      display: block;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 1rem;
      }

      .main-content {
        margin-left: 0;
        padding: 1rem;
      }

      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
      }

      .modules-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .stat-card {
        flex-direction: column;
        text-align: center;
      }

      .sidebar-footer {
        position: relative;
        width: 100%;
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">üïê AiClock</div>
      <ul class="sidebar-menu">
        <li><button class="menu-btn active" data-module="dashboard">üìä Dashboard</button></li>
        <li><button class="menu-btn" data-module="monitor">üî¥ Monitor Mode</button></li>
        <li><button class="menu-btn" data-module="attendance">‚úì Attendance</button></li>
        <li><button class="menu-btn" data-module="reports">üìà Reports</button></li>
        <li><button class="menu-btn" data-module="employees">üë• Employees</button></li>
        <li><button class="menu-btn" data-module="timecard">üïê Timecard</button></li>
        <li><button class="menu-btn" data-module="settings">‚öôÔ∏è Settings</button></li>
      </ul>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="header-title">
          <h1 id="businessName">Business Dashboard</h1>
          <p id="userEmail">Loading...</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" id="refreshBtn">‚Üª Refresh</button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div>
            <div class="stat-label">Active Employees</div>
            <div class="stat-value" id="activeEmployees">0</div>
            <div class="stat-subtext">Out of 5 slots</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úì</div>
          <div>
            <div class="stat-label">Present Today</div>
            <div class="stat-value" id="presentToday">0</div>
            <div class="stat-subtext">Clocked in</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üïê</div>
          <div>
            <div class="stat-label">Plan Status</div>
            <div class="stat-value" id="planStatus">Basic</div>
            <div class="stat-subtext">Active Plan</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div>
            <div class="stat-label">Attendance Rate</div>
            <div class="stat-value" id="attendanceRate">--</div>
            <div class="stat-subtext">This month</div>
          </div>
        </div>
      </div>

      <!-- Dashboard View -->
      <div class="view-section active" id="dashboardView">
        <div class="modules-section">
          <h2 class="section-title">Quick Access Modules</h2>
          <p class="section-description">Click any module to manage your business operations</p>

          <div class="modules-grid">
            <div class="module-card" data-module="monitor">
              <div class="module-icon">üìä</div>
              <div class="module-name">Monitor Mode</div>
              <div class="module-status">Live Status</div>
            </div>

            <div class="module-card" data-module="attendance">
              <div class="module-icon">‚úì</div>
              <div class="module-name">Attendance Tracker</div>
              <div class="module-status">History</div>
            </div>

            <div class="module-card" data-module="timecard">
              <div class="module-icon">üïê</div>
              <div class="module-name">Timecard</div>
              <div class="module-status">Daily Hours</div>
            </div>

            <div class="module-card" data-module="reports">
              <div class="module-icon">üìà</div>
              <div class="module-name">Reports</div>
              <div class="module-status">Analytics</div>
            </div>

            <div class="module-card" data-module="employees">
              <div class="module-icon">üë•</div>
              <div class="module-name">Employees</div>
              <div class="module-status">Manage Staff</div>
            </div>

            <div class="module-card" data-module="settings">
              <div class="module-icon">‚öôÔ∏è</div>
              <div class="module-name">Settings</div>
              <div class="module-status">Configuration</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monitor View (Real-Time) -->
      <div class="view-section" id="monitorView">
        <style>
          .monitor-header {
            background: #2c3e50;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
          }

          .monitor-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
          }

          .monitor-actions {
            display: flex;
            gap: 1rem;
          }

          .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
          }

          .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
          }

          .monitor-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
          }

          .status-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .status-header {
            padding: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
            text-align: center;
          }

          .status-header.in {
            background: #4caf50;
          }

          .status-header.out {
            background: #f44336;
          }

          .status-body {
            padding: 1.5rem;
            min-height: 300px;
          }

          .employee-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }

          .employee-item:last-child {
            border-bottom: none;
          }

          .employee-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
          }

          .employee-slot {
            color: #999;
            font-size: 0.85rem;
            margin-top: 0.25rem;
          }

          .employee-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f44336;
            text-align: right;
          }

          .no-employees {
            text-align: center;
            color: #999;
            padding: 2rem;
          }

          .monitor-footer {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .refresh-time {
            color: #667eea;
            font-weight: 600;
          }

          @media (max-width: 768px) {
            .monitor-header {
              flex-direction: column;
              gap: 1rem;
              text-align: center;
            }

            .monitor-content {
              grid-template-columns: 1fr;
            }
          }
        </style>

        <style>
          /* Employee Management Styles */
          .employees-container {
            padding: 1rem;
          }

          .employees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
          }

          .employee-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #667eea;
          }

          .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
          }

          .employee-card.inactive {
            border-left-color: #ccc;
            opacity: 0.7;
          }

          .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
          }

          .employee-info h3 {
            margin: 0 0 0.25rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
          }

          .employee-slot-badge {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
          }

          .employee-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
          }

          .employee-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
          }

          .detail-label {
            color: #666;
            font-weight: 500;
          }

          .detail-value {
            color: #2c3e50;
            font-weight: 600;
          }

          .employee-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
          }

          .employee-status.clocked-in {
            background: #d4edda;
            color: #155724;
          }

          .employee-status.clocked-out {
            background: #f8d7da;
            color: #721c24;
          }

          .employee-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
          }

          .btn-edit {
            flex: 1;
            padding: 0.6rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
          }

          .btn-edit:hover {
            background: #5568d3;
          }

          .btn-view {
            flex: 1;
            padding: 0.6rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
          }

          .btn-view:hover {
            background: #38a169;
          }

          .no-employees {
            text-align: center;
            padding: 3rem;
            color: #999;
            font-size: 1.1rem;
          }

          /* Employee Edit Modal */
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
          }

          .modal-employee {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
          }

          .modal-employee h2 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
          }

          .form-group {
            margin-bottom: 1.25rem;
          }

          .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
          }

          .form-group input,
          .form-group select,
          .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
          }

          .form-group input:focus,
          .form-group select:focus,
          .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          }

          .form-group textarea {
            resize: vertical;
            min-height: 80px;
          }

          .form-group input[readonly] {
            background: #f5f5f5;
            color: #666;
          }

          .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
          }

          .btn-save {
            flex: 1;
            padding: 0.75rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
          }

          .btn-save:hover {
            background: #38a169;
          }

          .btn-cancel {
            flex: 1;
            padding: 0.75rem;
            background: #e2e8f0;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
          }

          .btn-cancel:hover {
            background: #cbd5e0;
          }

          @media (max-width: 768px) {
            .employees-grid {
              grid-template-columns: 1fr;
            }
          }
        </style>

        <style>
          /* Timecard Module Styles */
          .timecard-container {
            padding: 1rem;
          }

          .timecard-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
          }

          .control-group {
            flex: 1;
            min-width: 200px;
          }

          .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
          }

          .control-group select,
          .control-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
          }

          .btn-refresh-timecard,
          .btn-print-timecard {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
          }

          .btn-refresh-timecard {
            background: #667eea;
            color: white;
          }

          .btn-refresh-timecard:hover {
            background: #5568d3;
          }

          .btn-print-timecard {
            background: #48bb78;
            color: white;
          }

          .btn-print-timecard:hover {
            background: #38a169;
          }

          .timecard-display {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
          }

          .timecard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
          }

          .timecard-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
          }

          .timecard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
          }

          .timecard-table-wrapper {
            overflow-x: auto;
            padding: 1rem;
          }

          .timecard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
          }

          .timecard-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
          }

          .timecard-table th:last-child,
          .timecard-table td:last-child {
            text-align: right;
          }

          .timecard-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
          }

          .timecard-table tr:hover {
            background: #f8f9fa;
          }

          .day-date {
            font-weight: 600;
            color: #2c3e50;
          }

          .day-name {
            color: #6c757d;
            font-size: 0.85rem;
          }

          .weekend {
            background: #fff3cd !important;
          }

          .no-data {
            color: #999;
            font-style: italic;
          }

          .time-in, .time-out {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
          }

          .hours-worked {
            font-weight: 600;
            color: #48bb78;
          }

          .overtime {
            color: #f6ad55;
            font-weight: 600;
          }

          .timecard-summary {
            background: #f8f9fa;
            padding: 1.5rem;
            border-top: 3px solid #667eea;
          }

          .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
          }

          .summary-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
          }

          .summary-item.overtime-item {
            border-left-color: #f6ad55;
          }

          .summary-item.total-item {
            border-left-color: #48bb78;
          }

          .summary-label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
          }

          .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
          }

          @media print {
            .timecard-controls,
            .sidebar,
            .btn-refresh-timecard,
            .btn-print-timecard {
              display: none !important;
            }

            .timecard-display {
              box-shadow: none;
            }
          }

          @media (max-width: 768px) {
            .timecard-controls {
              flex-direction: column;
              align-items: stretch;
            }

            .control-group {
              min-width: 100%;
            }

            .timecard-table {
              font-size: 0.8rem;
            }

            .timecard-table th,
            .timecard-table td {
              padding: 0.5rem;
            }
          }
        </style>

        <!-- Monitor Header -->
        <div class="monitor-header">
          <div class="monitor-title">
            <button class="back-btn" onclick="switchModule('dashboard')">‚Üê Back</button>
            <span>üïê LIVE ATTENDANCE MONITOR</span>
          </div>
          <button class="btn btn-primary" onclick="loadMonitorData()">‚Üª Refresh</button>
        </div>

        <!-- Debug Section -->
        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ffc107;">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-small" onclick="addTestEmployee()" style="background: #28a745; color: white;">+ Add Test Employee (IN)</button>
            <button class="btn btn-small" onclick="addTestEmployeeOut()" style="background: #dc3545; color: white;">+ Add Test Employee (OUT)</button>
            <button class="btn btn-small" onclick="clearAllStaff()" style="background: #6c757d; color: white;">Clear All Staff</button>
          </div>
        </div>

        <!-- Monitor Content -->
        <div class="monitor-content" id="monitorContent">
          <!-- IN Section -->
          <div class="status-section">
            <div class="status-header in">IN</div>
            <div class="status-body" id="inEmployees">
              <div class="no-employees">Loading...</div>
            </div>
          </div>

          <!-- OUT Section -->
          <div class="status-section">
            <div class="status-header out">OUT</div>
            <div class="status-body" id="outEmployees">
              <div class="no-employees">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Monitor Footer -->
        <div class="monitor-footer">
          ‚è± Auto-refreshes every 30 seconds ‚Ä¢ Last updated: <span class="refresh-time" id="lastUpdateTime">Just now</span>
        </div>
      </div>

      <!-- Reports View -->
      <div class="view-section" id="reportsView">
        <h2 class="section-title">Reports</h2>
        <p class="section-description">View detailed attendance and performance reports</p>
        <div id="reportsContent" style="padding: 2rem; text-align: center; color: #999;">
          Loading reports...
        </div>
      </div>

      <!-- Employees View -->
      <div class="view-section" id="employeesView">
        <h2 class="section-title">Employee Management</h2>
        <p class="section-description">Manage employee details and HR information</p>
        
        <div class="employees-container">
          <div id="employeesGrid" class="employees-grid">
            <!-- Employee cards will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Timecard View -->
      <div class="view-section" id="timecardView">
        <h2 class="section-title">Employee Timecard</h2>
        <p class="section-description">View monthly attendance and calculate working hours</p>
        
        <div class="timecard-container">
          <!-- Selection Controls -->
          <div class="timecard-controls">
            <div class="control-group">
              <label for="employeeSelect">Select Employee:</label>
              <select id="employeeSelect" onchange="loadTimecard()">
                <option value="">-- Select Employee --</option>
              </select>
            </div>
            
            <div class="control-group">
              <label for="monthSelect">Select Month:</label>
              <input type="month" id="monthSelect" onchange="loadTimecard()">
            </div>
            
            <button class="btn-refresh-timecard" onclick="loadTimecard()">üîÑ Refresh</button>
            <button class="btn-print-timecard" onclick="printTimecard()">üñ®Ô∏è Print</button>
          </div>
          
          <!-- Timecard Display -->
          <div id="timecardDisplay" class="timecard-display">
            <div style="text-align: center; padding: 3rem; color: #999;">
              Select an employee and month to view timecard
            </div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div class="view-section" id="settingsView">
        <h2 class="section-title">Settings</h2>
        <p class="section-description">Configure your business preferences</p>
        <div id="settingsContent" style="padding: 2rem; text-align: center; color: #999;">
          Loading settings...
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import authService from '../modules/auth/auth.service.js';
    import { doc, getDoc, collection, getDocs, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from '../config/firebase.js';

    let businessId = null;
    let pollingInterval = null;
    let statusUnsubscribe = null;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initDashboard();
    });

    async function initDashboard() {
      // Check authentication
      if (!authService.isAuthenticated() || authService.getUserRole() !== "business") {
        window.location.href = '/pages/login.html';
        return;
      }

      businessId = authService.getBusinessId();
      const businessName = sessionStorage.getItem("businessName");
      const userEmail = sessionStorage.getItem("userEmail") || sessionStorage.getItem("businessId");
      
      document.getElementById('businessName').textContent = businessName || "Business Dashboard";
      document.getElementById('userEmail').textContent = userEmail;

      loadDashboardData();
      setupEventListeners();
      setupRealtimeListeners();
    }

    function setupRealtimeListeners() {
      // Setup real-time listener for status collection
      const statusRef = collection(db, "businesses", businessId, "status");
      statusUnsubscribe = onSnapshot(statusRef, (snapshot) => {
        console.log("Status update received from Firebase");
        // Only update if monitor view is active
        if (document.querySelector('.menu-btn[data-module="monitor"].active')) {
          loadMonitorData();
        }
      }, (error) => {
        console.error("Error listening to status:", error);
      });
    }

    function setupEventListeners() {
      // Menu buttons
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const module = this.dataset.module;
          switchModule(module);
        });
      });

      // Module cards
      document.querySelectorAll('.module-card[data-module]').forEach(card => {
        card.addEventListener('click', function(e) {
          const module = this.dataset.module;
          switchModule(module);
        });
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (pollingInterval) clearInterval(pollingInterval);
        if (statusUnsubscribe) statusUnsubscribe();
        await authService.logout();
        window.location.href = '/pages/login.html';
      });

      // Refresh
      document.getElementById('refreshBtn').addEventListener('click', () => {
        loadDashboardData();
        loadMonitorData();
      });
    }

    function switchModule(module) {
      // Update menu
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.module === module) {
          btn.classList.add('active');
        }
      });

      // Update view
      document.querySelectorAll('.view-section').forEach(view => {
        view.classList.remove('active');
      });
      
      let viewId = module + 'View';
      if (module === 'dashboard') viewId = 'dashboardView';
      if (module === 'monitor') viewId = 'monitorView';
      
      const view = document.getElementById(viewId);
      if (view) {
        view.classList.add('active');
      }

      if (module === 'monitor') {
        loadMonitorData();
      } else {
        loadModuleData(module);
      }
    }

    async function loadDashboardData() {
      try {
        const businessRef = doc(db, "businesses", businessId);
        const businessDoc = await getDoc(businessRef);

        if (businessDoc.exists()) {
          const data = businessDoc.data();
          document.getElementById('planStatus').textContent = data.plan || 'Basic';
          
          // Load staff to count active employees
          const staffRef = collection(db, "businesses", businessId, "staff");
          const staffSnap = await getDocs(staffRef);
          const activeCount = Array.from(staffSnap.docs).filter(doc => doc.data().active).length;
          
          document.getElementById('activeEmployees').textContent = activeCount;
          document.getElementById('presentToday').textContent = activeCount;
          document.getElementById('attendanceRate').textContent = '95%';
        }
      } catch (error) {
        console.error("Error loading dashboard data:", error);
      }
    }

    async function loadMonitorData() {
      try {
        console.log("Loading monitor data for business:", businessId);
        
        const statusRef = collection(db, "businesses", businessId, "status");
        const statusSnap = await getDocs(statusRef);
        
        console.log("Retrieved status documents:", statusSnap.size);
        
        let inEmployees = [];
        let outEmployees = [];
        
        statusSnap.forEach(doc => {
          const status = doc.data();
          console.log("Processing employee:", status.employeeName, "attendanceStatus:", status.attendanceStatus);
          
          // Only show employees who have actually clocked in at some point (have lastClockTime)
          // This filters out unused slots that were auto-created
          if (!status.lastClockTime) {
            console.log("Skipping unused slot:", status.employeeName);
            return;
          }
          
          // Check attendanceStatus field for IN/OUT
          if (status.attendanceStatus === 'in') {
            inEmployees.push(status);
          } else {
            outEmployees.push(status);
          }
        });

        console.log("IN employees:", inEmployees.length);
        console.log("OUT employees:", outEmployees.length);

        // Render IN employees
        let inHtml = '';
        if (inEmployees.length === 0) {
          inHtml = '<div class="no-employees">No employees clocked in</div>';
        } else {
          inEmployees.forEach(emp => {
            const slotDisplay = emp.slot || emp.slotNumber || emp.employeeId || 'N/A';
            const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleTimeString() : 'N/A';
            inHtml += `
              <div class="employee-item">
                <div>
                  <div class="employee-name">${emp.employeeName}</div>
                  <div class="employee-slot">SLOT ${slotDisplay}</div>
                </div>
                <div class="employee-time">${lastTime}</div>
              </div>
            `;
          });
        }
        document.getElementById('inEmployees').innerHTML = inHtml;

        // Render OUT employees
        let outHtml = '';
        if (outEmployees.length === 0) {
          outHtml = '<div class="no-employees">No employees clocked out</div>';
        } else {
          outEmployees.forEach(emp => {
            const slotDisplay = emp.slot || emp.slotNumber || emp.employeeId || 'N/A';
            const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleTimeString() : 'N/A';
            outHtml += `
              <div class="employee-item">
                <div>
                  <div class="employee-name">${emp.employeeName}</div>
                  <div class="employee-slot">SLOT ${slotDisplay}</div>
                </div>
                <div class="employee-time">${lastTime}</div>
              </div>
            `;
          });
        }
        document.getElementById('outEmployees').innerHTML = outHtml;

        // Update timestamp
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('lastUpdateTime').textContent = timeStr;

      } catch (error) {
        console.error("Error loading monitor data:", error);
        console.error("Error code:", error.code);
        const errorMsg = error.code === 'permission-denied' ? 'Permission denied - check Firestore rules' : error.message;
        document.getElementById('inEmployees').innerHTML = '<div class="no-employees" style="color: #c33;">Error: ' + errorMsg + '</div>';
        document.getElementById('outEmployees').innerHTML = '<div class="no-employees"></div>';
      }
    }

    function formatDuration(timestamp) {
      // Format as HH:MM:SS
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    async function loadModuleData(module) {
      console.log('Loading module:', module);
      
      if (module === 'employees') {
        await loadEmployees();
        return;
      }
      
      if (module === 'timecard') {
        await initTimecard();
        return;
      }
      
      const contentIds = {
        'attendance': 'attendanceContent',
        'reports': 'reportsContent',
        'settings': 'settingsContent'
      };

      const contentId = contentIds[module];
      if (contentId) {
        const content = document.getElementById(contentId);
        if (content) {
          setTimeout(() => {
            content.innerHTML = `<p style="color: #999;">Module content for ${module} will be displayed here</p>`;
          }, 500);
        }
      }
    }

    async function loadEmployees() {
      try {
        const employeesGrid = document.getElementById('employeesGrid');
        employeesGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Loading employees...</div>';

        // Load all staff with lastClockTime (active employees who have clocked in)
        const staffRef = collection(db, "businesses", businessId, "staff");
        const statusRef = collection(db, "businesses", businessId, "status");
        
        const [staffSnap, statusSnap] = await Promise.all([
          getDocs(staffRef),
          getDocs(statusRef)
        ]);

        // Create a map of current statuses
        const statusMap = new Map();
        statusSnap.forEach(doc => {
          const status = doc.data();
          if (status.lastClockTime) {
            statusMap.set(doc.id, status);
          }
        });

        // Filter staff to only show those who have clocked in
        const activeEmployees = [];
        staffSnap.forEach(doc => {
          const staff = doc.data();
          const status = statusMap.get(doc.id);
          
          // Only include if they have a status record with lastClockTime
          if (status && status.lastClockTime) {
            activeEmployees.push({
              id: doc.id,
              ...staff,
              currentStatus: status.attendanceStatus,
              lastClockTime: status.lastClockTime
            });
          }
        });

        // Sort by slot number
        activeEmployees.sort((a, b) => (a.slot || 0) - (b.slot || 0));

        if (activeEmployees.length === 0) {
          employeesGrid.innerHTML = '<div class="no-employees">No employees found. Employees will appear here after their first clock-in.</div>';
          return;
        }

        // Render employee cards
        employeesGrid.innerHTML = activeEmployees.map(emp => {
          const isIn = emp.currentStatus === 'in';
          const statusClass = isIn ? 'clocked-in' : 'clocked-out';
          const statusText = isIn ? '‚óè Clocked In' : '‚óã Clocked Out';
          const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleString() : 'N/A';
          
          return `
            <div class="employee-card ${emp.active ? '' : 'inactive'}">
              <div class="employee-header">
                <div class="employee-info">
                  <h3>${emp.employeeName || 'Unnamed Employee'}</h3>
                  <div class="employee-status ${statusClass}">${statusText}</div>
                </div>
                <span class="employee-slot-badge">SLOT ${emp.slot || emp.employeeId}</span>
              </div>
              
              <div class="employee-details">
                <div class="employee-detail-row">
                  <span class="detail-label">Employee ID:</span>
                  <span class="detail-value">${emp.employeeId || 'N/A'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Badge Number:</span>
                  <span class="detail-value">${emp.badgeNumber || 'N/A'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">${emp.phone || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">${emp.email || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Position:</span>
                  <span class="detail-value">${emp.position || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Last Clock:</span>
                  <span class="detail-value">${lastTime}</span>
                </div>
              </div>
              
              <div class="employee-actions">
                <button class="btn-edit" onclick="editEmployee('${emp.id}')">‚úèÔ∏è Edit Details</button>
                <button class="btn-view" onclick="viewEmployeeHistory('${emp.id}')">üìä View History</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error("Error loading employees:", error);
        document.getElementById('employeesGrid').innerHTML = 
          '<div class="no-employees" style="color: #e53e3e;">Error loading employees: ' + error.message + '</div>';
      }
    }

    async function editEmployee(employeeId) {
      try {
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        const staffDoc = await getDoc(staffRef);
        
        if (!staffDoc.exists()) {
          alert('Employee not found');
          return;
        }

        const emp = staffDoc.data();
        
        const modal = `
          <div class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-employee" onclick="event.stopPropagation()">
              <h2>Edit Employee Details</h2>
              <form id="employeeEditForm" onsubmit="saveEmployee(event, '${employeeId}')">
                <div class="form-group">
                  <label>Employee Name*</label>
                  <input type="text" name="employeeName" value="${emp.employeeName || ''}" required>
                </div>
                
                <div class="form-group">
                  <label>Slot Number</label>
                  <input type="text" name="slot" value="${emp.slot || ''}" readonly>
                </div>
                
                <div class="form-group">
                  <label>Badge Number</label>
                  <input type="text" name="badgeNumber" value="${emp.badgeNumber || ''}" readonly>
                </div>
                
                <div class="form-group">
                  <label>Phone Number</label>
                  <input type="tel" name="phone" value="${emp.phone || ''}" placeholder="+27 XX XXX XXXX">
                </div>
                
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" name="email" value="${emp.email || ''}" placeholder="employee@example.com">
                </div>
                
                <div class="form-group">
                  <label>Position/Title</label>
                  <input type="text" name="position" value="${emp.position || ''}" placeholder="e.g., Technician, Manager">
                </div>
                
                <div class="form-group">
                  <label>Department</label>
                  <input type="text" name="department" value="${emp.department || ''}" placeholder="e.g., Production, Sales">
                </div>
                
                <div class="form-group">
                  <label>ID Number</label>
                  <input type="text" name="idNumber" value="${emp.idNumber || ''}" placeholder="SA ID Number">
                </div>
                
                <div class="form-group">
                  <label>Address</label>
                  <textarea name="address" placeholder="Full address">${emp.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                  <label>Hire Date</label>
                  <input type="date" name="hireDate" value="${emp.hireDate || ''}">
                </div>
                
                <div class="form-group">
                  <label>Hourly Rate (ZAR)</label>
                  <input type="number" name="hourlyRate" value="${emp.hourlyRate || ''}" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                  <label>Notes</label>
                  <textarea name="notes" placeholder="Additional notes or comments">${emp.notes || ''}</textarea>
                </div>
                
                <div class="modal-actions">
                  <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                  <button type="submit" class="btn-save">üíæ Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (error) {
        console.error("Error editing employee:", error);
        alert('Error: ' + error.message);
      }
    }

    async function saveEmployee(event, employeeId) {
      event.preventDefault();
      
      try {
        const form = event.target;
        const formData = new FormData(form);
        
        const employeeData = {
          employeeName: formData.get('employeeName'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          position: formData.get('position'),
          department: formData.get('department'),
          idNumber: formData.get('idNumber'),
          address: formData.get('address'),
          hireDate: formData.get('hireDate'),
          hourlyRate: parseFloat(formData.get('hourlyRate')) || 0,
          notes: formData.get('notes'),
          updatedAt: new Date().toISOString()
        };
        
        // Update Firebase
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        await setDoc(staffRef, employeeData, { merge: true });
        
        console.log("Employee updated successfully");
        
        // Close modal
        closeModal();
        
        // Reload employees
        await loadEmployees();
        
        alert('Employee details updated successfully!');
        
      } catch (error) {
        console.error("Error saving employee:", error);
        alert('Error saving: ' + error.message);
      }
    }

    function closeModal(event) {
      if (event && event.target.classList.contains('modal-overlay')) {
        event.target.remove();
      } else {
        document.querySelector('.modal-overlay')?.remove();
      }
    }

    async function viewEmployeeHistory(employeeId) {
      alert('Employee history view coming soon!');
      // TODO: Implement attendance history view
    }

    // Make functions globally available
    window.editEmployee = editEmployee;
    window.saveEmployee = saveEmployee;
    window.closeModal = closeModal;
    window.viewEmployeeHistory = viewEmployeeHistory;

    // ============================================
    // TIMECARD MODULE FUNCTIONS
    // ============================================
    
    async function initTimecard() {
      try {
        // Load employee list for dropdown
        const staffRef = collection(db, "businesses", businessId, "staff");
        const statusRef = collection(db, "businesses", businessId, "status");
        
        const [staffSnap, statusSnap] = await Promise.all([
          getDocs(staffRef),
          getDocs(statusRef)
        ]);

        // Create a map of employees with lastClockTime
        const statusMap = new Map();
        statusSnap.forEach(doc => {
          const status = doc.data();
          if (status.lastClockTime) {
            statusMap.set(doc.id, status);
          }
        });

        // Filter and populate employee dropdown
        const employeeSelect = document.getElementById('employeeSelect');
        employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
        
        const employees = [];
        staffSnap.forEach(doc => {
          const staff = doc.data();
          const status = statusMap.get(doc.id);
          
          if (status && status.lastClockTime) {
            employees.push({
              id: doc.id,
              name: staff.employeeName,
              slot: staff.slot
            });
          }
        });

        // Sort by slot
        employees.sort((a, b) => (a.slot || 0) - (b.slot || 0));

        // Add to dropdown
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.id;
          option.textContent = `${emp.name} (Slot ${emp.slot || emp.id})`;
          employeeSelect.appendChild(option);
        });

        // Set default month to current month
        const now = new Date();
        const monthInput = document.getElementById('monthSelect');
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      } catch (error) {
        console.error("Error initializing timecard:", error);
        alert('Error loading timecard: ' + error.message);
      }
    }

    async function loadTimecard() {
      const employeeId = document.getElementById('employeeSelect').value;
      const month = document.getElementById('monthSelect').value;
      const display = document.getElementById('timecardDisplay');

      if (!employeeId || !month) {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Select an employee and month to view timecard</div>';
        return;
      }

      try {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Loading timecard...</div>';

        // Get employee info
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        const staffDoc = await getDoc(staffRef);
        const employee = staffDoc.data();

        // Parse month
        const [year, monthNum] = month.split('-');
        const monthDate = new Date(year, monthNum - 1, 1);
        const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        // Get all days in month
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const dailyRecords = [];

        // Get working hours from settings (default 8 hours)
        const workingHours = 8; // TODO: Load from settings

        // Fetch attendance events for each day
        for (let day = 1; day <= daysInMonth; day++) {
          // Create date at noon to avoid timezone issues
          const date = new Date(year, monthNum - 1, day, 12, 0, 0);
          const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          const isWeekend = dayName === 'Sat' || dayName === 'Sun';

          try {
            // Query attendance events for this day and employee
            const eventsRef = collection(db, "businesses", businessId, "attendance_events", dateStr, employeeId);
            const eventsSnap = await getDocs(eventsRef);

            const events = [];
            eventsSnap.forEach(doc => {
              events.push(doc.data());
            });

            // Sort by timestamp
            events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Calculate hours for this day
            let clockIns = [];
            let clockOuts = [];
            let totalHours = 0;

            events.forEach(event => {
              if (event.type === 'clock-in') {
                clockIns.push(new Date(event.timestamp));
              } else if (event.type === 'clock-out') {
                clockOuts.push(new Date(event.timestamp));
              }
            });

            // Calculate work periods - pair each clock-in with next clock-out
            for (let i = 0; i < clockIns.length; i++) {
              // Find the next clock-out after this clock-in
              const nextClockOut = clockOuts.find(cout => cout > clockIns[i]);
              
              if (nextClockOut) {
                const hours = (nextClockOut - clockIns[i]) / (1000 * 60 * 60);
                // Only add positive hours
                if (hours > 0) {
                  totalHours += hours;
                }
              }
            }

            const overtime = Math.max(0, totalHours - workingHours);

            dailyRecords.push({
              date: dateStr,
              day: day,
              dayName: dayName,
              isWeekend: isWeekend,
              clockIns: clockIns,
              clockOuts: clockOuts,
              totalHours: totalHours,
              overtime: overtime,
              hasData: events.length > 0
            });

          } catch (error) {
            console.error(`Error fetching events for ${dateStr}:`, error);
            dailyRecords.push({
              date: dateStr,
              day: day,
              dayName: dayName,
              isWeekend: isWeekend,
              clockIns: [],
              clockOuts: [],
              totalHours: 0,
              overtime: 0,
              hasData: false
            });
          }
        }

        // Calculate totals
        const totalHours = dailyRecords.reduce((sum, record) => sum + record.totalHours, 0);
        const totalOvertime = dailyRecords.reduce((sum, record) => sum + record.overtime, 0);
        const daysWorked = dailyRecords.filter(r => r.hasData).length;

        // Render timecard
        display.innerHTML = `
          <div class="timecard-header">
            <h3>${employee.employeeName} - ${monthName}</h3>
            <p>Slot ${employee.slot || employeeId} ‚Ä¢ Badge ${employee.badgeNumber || 'N/A'}</p>
          </div>

          <div class="timecard-table-wrapper">
            <table class="timecard-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Clock In</th>
                  <th>Clock Out</th>
                  <th>Hours</th>
                  <th>Overtime</th>
                </tr>
              </thead>
              <tbody>
                ${dailyRecords.map(record => {
                  const clockInTime = record.clockIns.length > 0 
                    ? record.clockIns[0].toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })
                    : '-';
                  const clockOutTime = record.clockOuts.length > 0
                    ? record.clockOuts[record.clockOuts.length - 1].toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })
                    : '-';
                  const hours = record.totalHours > 0 ? record.totalHours.toFixed(2) : '-';
                  const overtime = record.overtime > 0 ? record.overtime.toFixed(2) : '-';

                  return `
                    <tr class="${record.isWeekend ? 'weekend' : ''}">
                      <td class="day-date">${record.day}</td>
                      <td class="day-name">${record.dayName}</td>
                      <td class="time-in ${!record.hasData ? 'no-data' : ''}">${clockInTime}</td>
                      <td class="time-out ${!record.hasData ? 'no-data' : ''}">${clockOutTime}</td>
                      <td class="hours-worked">${hours}</td>
                      <td class="overtime">${overtime}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="timecard-summary">
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Days Worked</div>
                <div class="summary-value">${daysWorked}</div>
              </div>
              <div class="summary-item total-item">
                <div class="summary-label">Total Hours</div>
                <div class="summary-value">${totalHours.toFixed(2)}</div>
              </div>
              <div class="summary-item overtime-item">
                <div class="summary-label">Total Overtime</div>
                <div class="summary-value">${totalOvertime.toFixed(2)}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Regular Hours</div>
                <div class="summary-value">${(totalHours - totalOvertime).toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error("Error loading timecard:", error);
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #e53e3e;">Error loading timecard: ' + error.message + '</div>';
      }
    }

    function printTimecard() {
      window.print();
    }

    // Make timecard functions globally available
    window.loadTimecard = loadTimecard;
    window.printTimecard = printTimecard;
    window.initTimecard = initTimecard;

    // Debug functions for testing
    async function addTestEmployee() {
      try {
        const staffRef = collection(db, "businesses", businessId, "staff");
        const slotRef = doc(staffRef, "1");
        await setDoc(slotRef, {
          employeeId: "1",
          employeeName: "John Smith",
          badgeNumber: "1001",
          deviceId: "device_1",
          slot: 1,
          active: true,
          assignedAt: new Date().toISOString(),
          createdAt: new Date().toISOString()
        });
        console.log("Test employee added (IN)");
        loadMonitorData();
      } catch (error) {
        console.error("Error adding test employee:", error);
        alert("Error: " + error.message);
      }
    }

    async function addTestEmployeeOut() {
      try {
        const staffRef = collection(db, "businesses", businessId, "staff");
        const slotRef = doc(staffRef, "2");
        await setDoc(slotRef, {
          employeeId: "2",
          employeeName: "Jane Doe",
          badgeNumber: "1002",
          deviceId: "device_2",
          slot: 2,
          active: false,
          assignedAt: new Date().toISOString(),
          createdAt: new Date().toISOString(),
          outTime: new Date().getTime()
        });
        console.log("Test employee added (OUT)");
        loadMonitorData();
      } catch (error) {
        console.error("Error adding test employee:", error);
        alert("Error: " + error.message);
      }
    }

    async function clearAllStaff() {
      try {
        if (!confirm("Are you sure? This will clear all staff data.")) return;
        
        const staffRef = collection(db, "businesses", businessId, "staff");
        const staffSnap = await getDocs(staffRef);
        
        for (let doc of staffSnap.docs) {
          await deleteDoc(doc.ref);
        }
        console.log("All staff cleared");
        loadMonitorData();
      } catch (error) {
        console.error("Error clearing staff:", error);
        alert("Error: " + error.message);
      }
    }
  </script>
</body>
</html>
