<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Dashboard - AiClock</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    .dashboard-wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 1rem;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebar-header {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 1rem;
    }

    .sidebar-menu button {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .sidebar-menu button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    .sidebar-menu button.active {
      background: rgba(255, 255, 255, 0.3);
      border-left: 3px solid white;
    }

    .sidebar-footer {
      position: absolute;
      bottom: 1rem;
      width: 180px;
    }

    .logout-btn {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255, 67, 67, 0.8);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 67, 67, 1);
    }

    /* Main Content */
    .main-content {
      margin-left: 200px;
      flex: 1;
      padding: 2rem;
    }

    .dashboard-header {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      flex-direction: column;
    }

    .header-title h1 {
      font-size: 1.8rem;
      color: #667eea;
      margin-bottom: 0.25rem;
    }

    .header-title p {
      color: #666;
      font-size: 0.95rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 2.5rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
    }

    .stat-subtext {
      color: #999;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    /* Modules Grid */
    .modules-section {
      margin-top: 2rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #333;
    }

    .section-description {
      color: #666;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1.5rem;
    }

    .module-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
    }

    .module-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .module-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .module-name {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .module-status {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
    }

    /* Views */
    .view-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .view-section.active {
      display: block;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 1rem;
      }

      .main-content {
        margin-left: 0;
        padding: 1rem;
      }

      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
      }

      .modules-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .stat-card {
        flex-direction: column;
        text-align: center;
      }

      .sidebar-footer {
        position: relative;
        width: 100%;
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">üïê AiClock</div>
      <ul class="sidebar-menu">
        <li><button class="menu-btn active" data-module="dashboard">üìä Dashboard</button></li>
        <li><button class="menu-btn" data-module="monitor">üî¥ Monitor Mode</button></li>
        <li><button class="menu-btn" data-module="attendance">‚úì Attendance</button></li>
        <li><button class="menu-btn" data-module="reports">üìà Reports</button></li>
        <li><button class="menu-btn" data-module="employees">üë• Employees</button></li>
        <li><button class="menu-btn" data-module="timecard">üïê Timecard</button></li>
        <li><button class="menu-btn" data-module="downloads">üì• Downloads</button></li>
        <li><a href="whatsapp-settings.html" style="display: block; color: inherit; text-decoration: none;"><button class="menu-btn">üì± WhatsApp</button></a></li>
        <li><button class="menu-btn" data-module="settings">‚öôÔ∏è Settings</button></li>
      </ul>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="header-title">
          <h1 id="businessName">Business Dashboard</h1>
          <p id="userEmail">Loading...</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" id="refreshBtn">‚Üª Refresh</button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div>
            <div class="stat-label">Active Employees</div>
            <div class="stat-value" id="activeEmployees">0</div>
            <div class="stat-subtext">Out of 5 slots</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úì</div>
          <div>
            <div class="stat-label">Present Today</div>
            <div class="stat-value" id="presentToday">0</div>
            <div class="stat-subtext">Clocked in</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üïê</div>
          <div>
            <div class="stat-label">Plan Status</div>
            <div class="stat-value" id="planStatus">Basic</div>
            <div class="stat-subtext">Active Plan</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div>
            <div class="stat-label">Attendance Rate</div>
            <div class="stat-value" id="attendanceRate">--</div>
            <div class="stat-subtext">This month</div>
          </div>
        </div>
      </div>

      <!-- Dashboard View -->
      <div class="view-section active" id="dashboardView">
        <div class="modules-section">
          <h2 class="section-title">Quick Access Modules</h2>
          <p class="section-description">Click any module to manage your business operations</p>

          <div class="modules-grid">
            <div class="module-card" data-module="monitor">
              <div class="module-icon">üìä</div>
              <div class="module-name">Monitor Mode</div>
              <div class="module-status">Live Status</div>
            </div>

            <div class="module-card" data-module="attendance">
              <div class="module-icon">‚úì</div>
              <div class="module-name">Attendance Tracker</div>
              <div class="module-status">History</div>
            </div>

            <div class="module-card" data-module="timecard">
              <div class="module-icon">üïê</div>
              <div class="module-name">Timecard</div>
              <div class="module-status">Daily Hours</div>
            </div>

            <div class="module-card" data-module="reports">
              <div class="module-icon">üìà</div>
              <div class="module-name">Reports</div>
              <div class="module-status">Analytics</div>
            </div>

            <div class="module-card" data-module="employees">
              <div class="module-icon">üë•</div>
              <div class="module-name">Employees</div>
              <div class="module-status">Manage Staff</div>
            </div>

            <div class="module-card" data-module="downloads">
              <div class="module-icon">üì•</div>
              <div class="module-name">Downloads</div>
              <div class="module-status">Apps & Tools</div>
            </div>

            <div class="module-card" data-module="settings">
              <div class="module-icon">‚öôÔ∏è</div>
              <div class="module-name">Settings</div>
              <div class="module-status">Configuration</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monitor View (Real-Time) -->
      <div class="view-section" id="monitorView">
        <style>
          .monitor-header {
            background: #2c3e50;
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
          }

          .monitor-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
          }

          .monitor-actions {
            display: flex;
            gap: 1rem;
          }

          .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
          }

          .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
          }

          .monitor-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
          }

          .status-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .status-header {
            padding: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
            text-align: center;
          }

          .status-header.in {
            background: #4caf50;
          }

          .status-header.out {
            background: #f44336;
          }

          .status-body {
            padding: 1.5rem;
            min-height: 300px;
          }

          .employee-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }

          .employee-item:last-child {
            border-bottom: none;
          }

          .employee-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
          }

          .employee-slot {
            color: #999;
            font-size: 0.85rem;
            margin-top: 0.25rem;
          }

          .employee-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f44336;
            text-align: right;
          }

          .no-employees {
            text-align: center;
            color: #999;
            padding: 2rem;
          }

          .monitor-footer {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .refresh-time {
            color: #667eea;
            font-weight: 600;
          }

          @media (max-width: 768px) {
            .monitor-header {
              flex-direction: column;
              gap: 1rem;
              text-align: center;
            }

            .monitor-content {
              grid-template-columns: 1fr;
            }
          }
        </style>

        <style>
          /* Employee Management Styles */
          .employees-container {
            padding: 1rem;
          }

          .employees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
          }

          .employee-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #667eea;
          }

          .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
          }

          .employee-card.inactive {
            border-left-color: #ccc;
            opacity: 0.7;
          }

          .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
          }

          .employee-info h3 {
            margin: 0 0 0.25rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
          }

          .employee-slot-badge {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
          }

          .employee-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
          }

          .employee-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
          }

          .detail-label {
            color: #666;
            font-weight: 500;
          }

          .detail-value {
            color: #2c3e50;
            font-weight: 600;
          }

          .employee-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
          }

          .employee-status.clocked-in {
            background: #d4edda;
            color: #155724;
          }

          .employee-status.clocked-out {
            background: #f8d7da;
            color: #721c24;
          }

          .employee-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
          }

          .btn-edit {
            flex: 1;
            padding: 0.6rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
          }

          .btn-edit:hover {
            background: #5568d3;
          }

          .btn-view {
            flex: 1;
            padding: 0.6rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
          }

          .btn-view:hover {
            background: #38a169;
          }

          .no-employees {
            text-align: center;
            padding: 3rem;
            color: #999;
            font-size: 1.1rem;
          }

          /* Settings Styles */
          .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            padding: 2rem;
          }

          .settings-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }

          .settings-card h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.2rem;
          }

          .form-group {
            margin-bottom: 1.5rem;
          }

          .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
          }

          .form-group input,
          .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
          }

          .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6c757d;
            font-size: 0.85rem;
          }

          .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
          }

          .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
          }

          .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
          }

          .day-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .day-config {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
          }

          .day-header {
            margin-bottom: 0.75rem;
          }

          .day-header label {
            font-size: 1rem;
            cursor: pointer;
          }

          .day-checkbox {
            width: auto !important;
            margin-right: 0.5rem;
          }

          .day-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
          }

          .day-details input {
            padding: 0.5rem;
            font-size: 0.9rem;
          }

          /* Employee Edit Modal */
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
          }

          .modal-employee {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
          }

          .modal-employee h2 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
          }

          .form-group {
            margin-bottom: 1.25rem;
          }

          .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
          }

          .form-group input,
          .form-group select,
          .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
          }

          .form-group input:focus,
          .form-group select:focus,
          .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          }

          .form-group textarea {
            resize: vertical;
            min-height: 80px;
          }

          .form-group input[readonly] {
            background: #f5f5f5;
            color: #666;
          }

          .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
          }

          .btn-save {
            flex: 1;
            padding: 0.75rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
          }

          .btn-save:hover {
            background: #38a169;
          }

          .btn-cancel {
            flex: 1;
            padding: 0.75rem;
            background: #e2e8f0;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
          }

          .btn-cancel:hover {
            background: #cbd5e0;
          }

          @media (max-width: 768px) {
            .employees-grid {
              grid-template-columns: 1fr;
            }
          }
        </style>

        <style>
          /* Timecard Module Styles */
          .timecard-container {
            padding: 1rem;
          }

          .timecard-controls,
          .report-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
          }

          .control-group {
            flex: 1;
            min-width: 200px;
          }

          .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
          }

          .control-group select,
          .control-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
          }

          .btn-refresh-timecard,
          .btn-print-timecard,
          .btn-refresh-reports,
          .btn-print-reports {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
          }

          .btn-refresh-timecard,
          .btn-refresh-reports {
            background: #667eea;
            color: white;
          }

          .btn-refresh-timecard:hover,
          .btn-refresh-reports:hover {
            background: #5568d3;
          }

          .btn-print-timecard,
          .btn-print-reports {
            background: #48bb78;
            color: white;
          }

          .btn-print-timecard:hover,
          .btn-print-reports:hover {
            background: #38a169;
          }

          .timecard-display {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
          }

          .timecard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
          }

          .timecard-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
          }

          .timecard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
          }

          .timecard-table-wrapper {
            overflow-x: auto;
            padding: 1rem;
          }

          .timecard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
          }

          .timecard-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
          }

          .timecard-table th:last-child,
          .timecard-table td:last-child {
            text-align: right;
          }

          .timecard-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
          }

          .timecard-table tr:hover {
            background: #f8f9fa;
          }

          .day-date {
            font-weight: 600;
            color: #2c3e50;
          }

          .day-name {
            color: #6c757d;
            font-size: 0.85rem;
          }

          .weekend {
            background: #fff3cd !important;
          }

          .no-data {
            color: #999;
            font-style: italic;
          }

          .time-in, .time-out {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
          }

          .hours-worked {
            font-weight: 600;
            color: #48bb78;
          }

          .overtime {
            color: #f6ad55;
            font-weight: 600;
          }

          .timecard-summary {
            background: #f8f9fa;
            padding: 1.5rem;
            border-top: 3px solid #667eea;
          }

          .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
          }

          .summary-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
          }

          .summary-item.overtime-item {
            border-left-color: #f6ad55;
          }

          .summary-item.total-item {
            border-left-color: #48bb78;
          }

          .summary-label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
          }

          .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
          }

          /* ============================================
             REPORTS MODULE STYLES
             ============================================ */

          .reports-container {
            padding: 1rem;
          }

          .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          }

          .report-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
          }

          .report-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
          }

          .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
          }

          .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
          }

          .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
          }

          .stat-card.highlight {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border-left: 4px solid #2f855a;
          }

          .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }

          .stat-card.highlight .stat-label {
            color: rgba(255, 255, 255, 0.9);
          }

          .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
          }

          .stat-card.highlight .stat-value {
            color: white;
          }

          .report-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
          }

          .report-section h4 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            font-size: 1.3rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #667eea;
          }

          .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
          }

          .report-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
          }

          .report-table th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }

          .report-table td {
            padding: 0.9rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
          }

          .report-table tbody tr:hover {
            background: #f7fafc;
          }

          .report-table tbody tr:last-child td {
            border-bottom: none;
          }

          .report-table .total-row {
            background: #f8f9fa !important;
            font-weight: 700;
            border-top: 2px solid #667eea;
          }

          .report-table .total-row td {
            padding: 1.2rem 0.75rem;
            color: #2c3e50;
          }

          @media print {
            /* Hide everything first */
            * {
              visibility: hidden;
            }

            /* Show timecard or reports elements */
            #timecardView,
            #timecardView *,
            #reportsView,
            #reportsView *,
            .print-company-info,
            .print-company-info *,
            .timecard-display,
            .timecard-display *,
            .reports-container,
            .reports-container *,
            .print-footer,
            .print-footer * {
              visibility: visible;
            }

            /* Completely hide dashboard and other sections */
            .sidebar,
            .header,
            .menu-sidebar,
            .btn-refresh-timecard,
            .btn-print-timecard,
            .btn-refresh-reports,
            .btn-print-reports,
            .timecard-controls,
            .report-controls,
            .section-title,
            .section-description,
            #dashboardView,
            #monitorView,
            #employeesView,
            #attendanceView,
            #settingsView {
              display: none !important;
              visibility: hidden !important;
            }

            /* Reset page styling */
            body {
              background: white !important;
              margin: 0 !important;
              padding: 0 !important;
              font-family: Arial, sans-serif !important;
            }

            /* Position timecard at top */
            #timecardView {
              position: absolute !important;
              top: 0 !important;
              left: 0 !important;
              width: 100% !important;
              padding: 0 !important;
              margin: 0 !important;
            }

            .timecard-container {
              padding: 0 !important;
              margin: 0 !important;
            }

            /* Company header styling - compact */
            .print-company-info {
              display: block !important;
              padding: 0.8rem !important;
              background: #f8f9fa !important;
              border-bottom: 2px solid #667eea !important;
              text-align: center !important;
              margin: 0 !important;
              -webkit-print-color-adjust: exact !important;
              color-adjust: exact !important;
            }

            .print-company-info h2 {
              margin: 0 0 0.3rem 0 !important;
              color: #2c3e50 !important;
              font-size: 1.2rem !important;
            }

            .print-company-info p {
              margin: 0 !important;
              color: #6c757d !important;
              font-size: 0.9rem !important;
            }

            /* Timecard display styling */
            .timecard-display {
              box-shadow: none !important;
              border-radius: 0 !important;
              margin: 0 !important;
              padding: 0 !important;
              background: white !important;
            }

            /* Timecard header - compact */
            .timecard-header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
              color: white !important;
              padding: 1rem !important;
              text-align: center !important;
              margin: 0 !important;
              -webkit-print-color-adjust: exact !important;
              color-adjust: exact !important;
            }

            .timecard-header h3 {
              font-size: 1.3rem !important;
              margin: 0 0 0.3rem 0 !important;
              color: white !important;
            }

            .timecard-header p {
              font-size: 0.9rem !important;
              margin: 0 !important;
              color: white !important;
              opacity: 0.95 !important;
            }

            /* Business timecard table styling */
            .timecard-table-wrapper {
              padding: 10px 20px !important;
            }

            .timecard-table {
              width: 100% !important;
              border-collapse: collapse !important;
              font-size: 9pt !important;
              margin: 0 !important;
              border: 1px solid black !important;
            }

            .timecard-table th {
              background: white !important;
              color: black !important;
              padding: 8px 4px !important;
              text-align: center !important;
              font-weight: bold !important;
              border: 1px solid black !important;
              font-size: 8pt !important;
            }

            .timecard-table td {
              padding: 6px 4px !important;
              border: 1px solid black !important;
              color: black !important;
              font-size: 8pt !important;
              text-align: center !important;
            }

            .timecard-table tr:nth-child(even) {
              background: white !important;
            }

            .weekend {
              background: #f5f5f5 !important;
            }

            /* Business timecard summary section */
            .timecard-summary {
              background: white !important;
              padding: 15px 20px !important;
              border-top: 2px solid black !important;
              display: flex !important;
              justify-content: space-between !important;
            }

            .summary-grid {
              display: flex !important;
              justify-content: space-between !important;
              width: 100% !important;
              gap: 40px !important;
            }

            .summary-section {
              display: flex !important;
              flex-direction: column !important;
              align-items: flex-start !important;
            }

            .summary-item {
              background: white !important;
              padding: 0 !important;
              border: none !important;
              text-align: left !important;
              margin-bottom: 5px !important;
              display: flex !important;
              align-items: center !important;
            }

            .summary-label {
              color: black !important;
              font-size: 10pt !important;
              font-weight: bold !important;
              margin-right: 15px !important;
              min-width: 80px !important;
            }

            .summary-value {
              font-size: 12pt !important;
              font-weight: bold !important;
              color: black !important;
            }

            /* Hide print footer for business format */
            .print-footer {
              display: none !important;
            }

            /* Page setup - single page */
            @page {
              margin: 0.4in;
              size: letter;
            }

            /* Page break controls */
            .timecard-table {
              page-break-inside: auto !important;
            }

            .timecard-table tr {
              page-break-inside: avoid !important;
            }

            .timecard-table thead {
              display: table-header-group !important;
            }
          }

          @media (max-width: 768px) {
            .timecard-controls {
              flex-direction: column;
              align-items: stretch;
            }

            .control-group {
              min-width: 100%;
            }

            .timecard-table {
              font-size: 0.8rem;
            }

            .timecard-table th,
            .timecard-table td {
              padding: 0.5rem;
            }
          }
        </style>

        <!-- Monitor Header -->
        <div class="monitor-header">
          <div class="monitor-title">
            <button class="back-btn" onclick="switchModule('dashboard')">‚Üê Back</button>
            <span>üïê LIVE ATTENDANCE MONITOR</span>
          </div>
          <button class="btn btn-primary" onclick="loadMonitorData()">‚Üª Refresh</button>
        </div>

        <!-- Debug Section -->
        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ffc107;">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-small" onclick="addTestEmployee()" style="background: #28a745; color: white;">+ Add Test Employee (IN)</button>
            <button class="btn btn-small" onclick="addTestEmployeeOut()" style="background: #dc3545; color: white;">+ Add Test Employee (OUT)</button>
            <button class="btn btn-small" onclick="clearAllStaff()" style="background: #6c757d; color: white;">Clear All Staff</button>
          </div>
        </div>

        <!-- Monitor Content -->
        <div class="monitor-content" id="monitorContent">
          <!-- IN Section -->
          <div class="status-section">
            <div class="status-header in">IN</div>
            <div class="status-body" id="inEmployees">
              <div class="no-employees">Loading...</div>
            </div>
          </div>

          <!-- OUT Section -->
          <div class="status-section">
            <div class="status-header out">OUT</div>
            <div class="status-body" id="outEmployees">
              <div class="no-employees">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Monitor Footer -->
        <div class="monitor-footer">
          ‚è± Auto-refreshes every 30 seconds ‚Ä¢ Last updated: <span class="refresh-time" id="lastUpdateTime">Just now</span>
        </div>
      </div>

      <!-- Reports View -->
      <div class="view-section" id="reportsView">
        <h2 class="section-title">Reports</h2>
        <p class="section-description">View detailed attendance and performance reports</p>
        
        <div class="reports-container">
          <!-- Report Selection Controls -->
          <div class="report-controls">
            <div class="control-group">
              <label for="reportMonth">Select Month:</label>
              <input type="month" id="reportMonth" onchange="loadReports()">
            </div>
            <button class="btn-refresh-reports" onclick="loadReports()">üîÑ Refresh Reports</button>
            <button class="btn-print-reports" onclick="printReports()">üñ®Ô∏è Print</button>
          </div>

          <!-- Reports Content -->
          <div id="reportsContent" style="padding: 2rem;">
            <div style="text-align: center; color: #999;">Select a month to generate reports</div>
          </div>
        </div>
      </div>

      <!-- Employees View -->
      <div class="view-section" id="employeesView">
        <h2 class="section-title">Employee Management</h2>
        <p class="section-description">Manage employee details and HR information</p>
        
        <div class="employees-container">
          <div id="employeesGrid" class="employees-grid">
            <!-- Employee cards will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Timecard View -->
      <div class="view-section" id="timecardView">
        <h2 class="section-title">Employee Timecard</h2>
        <p class="section-description">View monthly attendance and calculate working hours</p>
        
        <div class="timecard-container">
          <!-- Print-Only Company Header (Hidden on Screen) -->
          <div class="print-company-info" style="display: none;">
            <h1>TIME CARD REPORT</h1>
            <div class="timecard-details">
              <div class="detail-row">
                <div class="detail-item">
                  <label>PayPeriod:</label>
                  <span>Monthly</span>
                </div>
                <div class="detail-item">
                  <label>Roster:</label>
                  <span>General</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-item">
                  <label>Division:</label>
                  <span>Admin</span>
                </div>
                <div class="detail-item">
                  <label>Group:</label>
                  <span>All</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-item">
                  <label>Department:</label>
                  <span>All</span>
                </div>
                <div class="detail-item">
                  <label>Cost Centre:</label>
                  <span>All</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Selection Controls -->
          <div class="timecard-controls">
            <div class="control-group">
              <label for="employeeSelect">Select Employee:</label>
              <select id="employeeSelect" onchange="loadTimecard()">
                <option value="">-- Select Employee --</option>
              </select>
            </div>
            
            <div class="control-group">
              <label for="monthSelect">Select Month:</label>
              <input type="month" id="monthSelect" onchange="loadTimecard()">
            </div>
            
            <button class="btn-refresh-timecard" onclick="loadTimecard()">üîÑ Refresh</button>
            <button class="btn-print-timecard" onclick="printTimecard()">üñ®Ô∏è Print</button>
          </div>
          
          <!-- Timecard Display -->
          <div id="timecardDisplay" class="timecard-display">
            <div style="text-align: center; padding: 3rem; color: #999;">
              Select an employee and month to view timecard
            </div>
          </div>

          <!-- Print-Only Footer (Hidden on Screen) -->
          <div class="print-footer" style="display: none;">
            <p>Generated on <span id="printDate"></span> | AI Clock Attendance System</p>
            <p>This is an official timecard record. For questions, contact your supervisor.</p>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div class="view-section" id="settingsView">
        <h2 class="section-title">Business Settings</h2>
        <p class="section-description">Configure your business preferences and working hours</p>
        
        <div class="settings-container">
          <div class="settings-card">
            <h3>üìã Business Information</h3>
            <form id="businessInfoForm">
              <div class="form-group">
                <label>Business Name</label>
                <input type="text" id="businessName" required>
              </div>
              
              <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="businessPhone" placeholder="+27...">
              </div>
              
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="businessEmail">
              </div>
              
              <div class="form-group">
                <label>Currency</label>
                <select id="businessCurrency">
                  <option value="R">ZAR (R)</option>
                  <option value="$">USD ($)</option>
                  <option value="‚Ç¨">EUR (‚Ç¨)</option>
                  <option value="¬£">GBP (¬£)</option>
                </select>
              </div>
              
              <button type="submit" class="btn-primary">üíæ Save Business Info</button>
            </form>
          </div>
          
          <div class="settings-card">
            <h3>üìÖ Working Days & Schedule</h3>
            <form id="workingDaysForm">
              <p style="color: #6c757d; margin-bottom: 1rem;">Configure each day's schedule, working hours, and pay rates</p>
              
              <div class="day-settings">
                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="monday" class="day-checkbox"> <strong>Monday</strong></label>
                  </div>
                  <div class="day-details" id="mondayDetails">
                    <input type="time" id="mondayStart" value="08:00" placeholder="Start">
                    <input type="time" id="mondayEnd" value="17:00" placeholder="End">
                    <input type="number" id="mondayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="tuesday" class="day-checkbox"> <strong>Tuesday</strong></label>
                  </div>
                  <div class="day-details" id="tuesdayDetails">
                    <input type="time" id="tuesdayStart" value="08:00" placeholder="Start">
                    <input type="time" id="tuesdayEnd" value="17:00" placeholder="End">
                    <input type="number" id="tuesdayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="wednesday" class="day-checkbox"> <strong>Wednesday</strong></label>
                  </div>
                  <div class="day-details" id="wednesdayDetails">
                    <input type="time" id="wednesdayStart" value="08:00" placeholder="Start">
                    <input type="time" id="wednesdayEnd" value="17:00" placeholder="End">
                    <input type="number" id="wednesdayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="thursday" class="day-checkbox"> <strong>Thursday</strong></label>
                  </div>
                  <div class="day-details" id="thursdayDetails">
                    <input type="time" id="thursdayStart" value="08:00" placeholder="Start">
                    <input type="time" id="thursdayEnd" value="17:00" placeholder="End">
                    <input type="number" id="thursdayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="friday" class="day-checkbox"> <strong>Friday</strong></label>
                  </div>
                  <div class="day-details" id="fridayDetails">
                    <input type="time" id="fridayStart" value="08:00" placeholder="Start">
                    <input type="time" id="fridayEnd" value="17:00" placeholder="End">
                    <input type="number" id="fridayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="saturday" class="day-checkbox"> <strong>Saturday</strong></label>
                  </div>
                  <div class="day-details" id="saturdayDetails">
                    <input type="time" id="saturdayStart" value="08:00" placeholder="Start">
                    <input type="time" id="saturdayEnd" value="14:30" placeholder="End">
                    <input type="number" id="saturdayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>

                <div class="day-config">
                  <div class="day-header">
                    <label><input type="checkbox" id="sunday" class="day-checkbox"> <strong>Sunday</strong></label>
                  </div>
                  <div class="day-details" id="sundayDetails">
                    <input type="time" id="sundayStart" value="08:00" placeholder="Start">
                    <input type="time" id="sundayEnd" value="17:00" placeholder="End">
                    <input type="number" id="sundayRate" step="0.01" min="0" placeholder="Pay Rate/hr">
                  </div>
                </div>
              </div>
              
              <button type="submit" class="btn-primary">üíæ Save Working Schedule</button>
            </form>
          </div>
          
          <div class="settings-card">
            <h3>üéâ Public Holidays</h3>
            <form id="publicHolidaysForm">
              <div class="form-group">
                <label>Public Holidays (YYYY-MM-DD, one per line)</label>
                <textarea id="publicHolidays" rows="6" placeholder="2026-01-01&#10;2026-03-21&#10;2026-04-18&#10;2026-04-19&#10;2026-04-27"></textarea>
                <small>Add dates when business is closed (no work, no pay calculations)</small>
              </div>
              
              <button type="submit" class="btn-primary">üíæ Save Holidays</button>
            </form>
          </div>
          
          <div class="settings-card">
            <h3>‚è∞ Default Working Hours</h3>
            <form id="workingHoursForm">
              <div class="form-group">
                <label>Break Duration (minutes)</label>
                <input type="number" id="breakDuration" value="60" min="0">
                <small>Unpaid break time deducted from daily hours</small>
              </div>
              
              <div class="form-group">
                <label>Overtime Calculation</label>
                <select id="overtimeRule">
                  <option value="none">No Overtime</option>
                  <option value="daily">Daily (over scheduled hours)</option>
                  <option value="weekly">Weekly (over 40 hours)</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Overtime Rate Multiplier</label>
                <input type="number" id="overtimeMultiplier" value="1.5" step="0.1" min="1">
                <small>e.g., 1.5 = time and a half</small>
              </div>
              
              <button type="submit" class="btn-primary">üíæ Save Working Hours</button>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import authService from '../modules/auth/auth.service.js';
    import { doc, getDoc, collection, getDocs, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from '../config/firebase.js';

    let businessId = null;
    let pollingInterval = null;
    let statusUnsubscribe = null;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initDashboard();
    });

    async function initDashboard() {
      // Check authentication
      if (!authService.isAuthenticated() || authService.getUserRole() !== "business") {
        window.location.href = '/pages/login.html';
        return;
      }

      businessId = authService.getBusinessId();
      const businessName = sessionStorage.getItem("businessName");
      const userEmail = sessionStorage.getItem("userEmail") || sessionStorage.getItem("businessId");
      
      document.getElementById('businessName').textContent = businessName || "Business Dashboard";
      document.getElementById('userEmail').textContent = userEmail;

      loadDashboardData();
      setupEventListeners();
      setupRealtimeListeners();
    }

    function setupRealtimeListeners() {
      // Setup real-time listener for status collection
      const statusRef = collection(db, "businesses", businessId, "status");
      statusUnsubscribe = onSnapshot(statusRef, (snapshot) => {
        console.log("Status update received from Firebase");
        // Only update if monitor view is active
        if (document.querySelector('.menu-btn[data-module="monitor"].active')) {
          loadMonitorData();
        }
      }, (error) => {
        console.error("Error listening to status:", error);
      });
    }

    function setupEventListeners() {
      // Menu buttons
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const module = this.dataset.module;
          switchModule(module);
        });
      });

      // Module cards
      document.querySelectorAll('.module-card[data-module]').forEach(card => {
        card.addEventListener('click', function(e) {
          const module = this.dataset.module;
          switchModule(module);
        });
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (pollingInterval) clearInterval(pollingInterval);
        if (statusUnsubscribe) statusUnsubscribe();
        await authService.logout();
        window.location.href = '/pages/login.html';
      });

      // Refresh
      document.getElementById('refreshBtn').addEventListener('click', () => {
        loadDashboardData();
        loadMonitorData();
      });
    }

    function switchModule(module) {
      // Update menu
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.module === module) {
          btn.classList.add('active');
        }
      });

      // Update view
      document.querySelectorAll('.view-section').forEach(view => {
        view.classList.remove('active');
      });
      
      let viewId = module + 'View';
      if (module === 'dashboard') viewId = 'dashboardView';
      if (module === 'monitor') viewId = 'monitorView';
      // Modules that use dashboardView container
      if (module === 'downloads' || module === 'attendance' || module === 'reports' || 
          module === 'employees' || module === 'timecard' || module === 'settings') {
        viewId = 'dashboardView';
      }
      
      const view = document.getElementById(viewId);
      if (view) {
        view.classList.add('active');
      }

      if (module === 'monitor') {
        loadMonitorData();
      } else {
        loadModuleData(module);
      }
    }

    async function loadDashboardData() {
      try {
        const businessRef = doc(db, "businesses", businessId);
        const businessDoc = await getDoc(businessRef);

        if (businessDoc.exists()) {
          const data = businessDoc.data();
          document.getElementById('planStatus').textContent = data.plan || 'Basic';
          
          // Load staff to count active employees
          const staffRef = collection(db, "businesses", businessId, "staff");
          const staffSnap = await getDocs(staffRef);
          const activeCount = Array.from(staffSnap.docs).filter(doc => doc.data().active).length;
          
          document.getElementById('activeEmployees').textContent = activeCount;
          document.getElementById('presentToday').textContent = activeCount;
          document.getElementById('attendanceRate').textContent = '95%';
        }
      } catch (error) {
        console.error("Error loading dashboard data:", error);
      }
    }

    async function loadMonitorData() {
      try {
        console.log("Loading monitor data for business:", businessId);
        
        const statusRef = collection(db, "businesses", businessId, "status");
        const statusSnap = await getDocs(statusRef);
        
        console.log("Retrieved status documents:", statusSnap.size);
        
        let inEmployees = [];
        let outEmployees = [];
        
        statusSnap.forEach(doc => {
          const status = doc.data();
          console.log("Processing employee:", status.employeeName, "attendanceStatus:", status.attendanceStatus);
          
          // Only show employees who have actually clocked in at some point (have lastClockTime)
          // This filters out unused slots that were auto-created
          if (!status.lastClockTime) {
            console.log("Skipping unused slot:", status.employeeName);
            return;
          }
          
          // Check attendanceStatus field for IN/OUT
          if (status.attendanceStatus === 'in') {
            inEmployees.push(status);
          } else {
            outEmployees.push(status);
          }
        });

        console.log("IN employees:", inEmployees.length);
        console.log("OUT employees:", outEmployees.length);

        // Render IN employees
        let inHtml = '';
        if (inEmployees.length === 0) {
          inHtml = '<div class="no-employees">No employees clocked in</div>';
        } else {
          inEmployees.forEach(emp => {
            const slotDisplay = emp.slot || emp.slotNumber || emp.employeeId || 'N/A';
            const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleTimeString() : 'N/A';
            inHtml += `
              <div class="employee-item">
                <div>
                  <div class="employee-name">${emp.employeeName}</div>
                  <div class="employee-slot">SLOT ${slotDisplay}</div>
                </div>
                <div class="employee-time">${lastTime}</div>
              </div>
            `;
          });
        }
        document.getElementById('inEmployees').innerHTML = inHtml;

        // Render OUT employees
        let outHtml = '';
        if (outEmployees.length === 0) {
          outHtml = '<div class="no-employees">No employees clocked out</div>';
        } else {
          outEmployees.forEach(emp => {
            const slotDisplay = emp.slot || emp.slotNumber || emp.employeeId || 'N/A';
            const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleTimeString() : 'N/A';
            outHtml += `
              <div class="employee-item">
                <div>
                  <div class="employee-name">${emp.employeeName}</div>
                  <div class="employee-slot">SLOT ${slotDisplay}</div>
                </div>
                <div class="employee-time">${lastTime}</div>
              </div>
            `;
          });
        }
        document.getElementById('outEmployees').innerHTML = outHtml;

        // Update timestamp
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('lastUpdateTime').textContent = timeStr;

      } catch (error) {
        console.error("Error loading monitor data:", error);
        console.error("Error code:", error.code);
        const errorMsg = error.code === 'permission-denied' ? 'Permission denied - check Firestore rules' : error.message;
        document.getElementById('inEmployees').innerHTML = '<div class="no-employees" style="color: #c33;">Error: ' + errorMsg + '</div>';
        document.getElementById('outEmployees').innerHTML = '<div class="no-employees"></div>';
      }
    }

    function formatDuration(timestamp) {
      // Format as HH:MM:SS
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    async function loadModuleData(module) {
      console.log('Loading module:', module);
      
      if (module === 'employees') {
        await loadEmployees();
        return;
      }
      
      if (module === 'timecard') {
        await initTimecard();
        return;
      }
      
      if (module === 'reports') {
        await initReports();
        return;
      }

      if (module === 'downloads') {
        await loadDownloads();
        return;
      }
      
      if (module === 'settings') {
        await loadSettings();
        return;
      }
      
      const contentIds = {
        'attendance': 'attendanceContent'
      };

      const contentId = contentIds[module];
      if (contentId) {
        const content = document.getElementById(contentId);
        if (content) {
          setTimeout(() => {
            content.innerHTML = `<p style="color: #999;">Module content for ${module} will be displayed here</p>`;
          }, 500);
        }
      }
    }

    async function loadEmployees() {
      try {
        const employeesGrid = document.getElementById('employeesGrid');
        employeesGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Loading employees...</div>';

        // Load all staff with lastClockTime (active employees who have clocked in)
        const staffRef = collection(db, "businesses", businessId, "staff");
        const statusRef = collection(db, "businesses", businessId, "status");
        
        const [staffSnap, statusSnap] = await Promise.all([
          getDocs(staffRef),
          getDocs(statusRef)
        ]);

        // Create a map of current statuses
        const statusMap = new Map();
        statusSnap.forEach(doc => {
          const status = doc.data();
          if (status.lastClockTime) {
            statusMap.set(doc.id, status);
          }
        });

        // Filter staff to only show those who have clocked in
        const activeEmployees = [];
        staffSnap.forEach(doc => {
          const staff = doc.data();
          const status = statusMap.get(doc.id);
          
          // Only include if they have a status record with lastClockTime
          if (status && status.lastClockTime) {
            activeEmployees.push({
              id: doc.id,
              ...staff,
              currentStatus: status.attendanceStatus,
              lastClockTime: status.lastClockTime
            });
          }
        });

        // Sort by slot number
        activeEmployees.sort((a, b) => (a.slot || 0) - (b.slot || 0));

        if (activeEmployees.length === 0) {
          employeesGrid.innerHTML = '<div class="no-employees">No employees found. Employees will appear here after their first clock-in.</div>';
          return;
        }

        // Render employee cards
        employeesGrid.innerHTML = activeEmployees.map(emp => {
          const isIn = emp.currentStatus === 'in';
          const statusClass = isIn ? 'clocked-in' : 'clocked-out';
          const statusText = isIn ? '‚óè Clocked In' : '‚óã Clocked Out';
          const lastTime = emp.lastClockTime ? new Date(emp.lastClockTime).toLocaleString() : 'N/A';
          
          return `
            <div class="employee-card ${emp.active ? '' : 'inactive'}">
              <div class="employee-header">
                <div class="employee-info">
                  <h3>${emp.employeeName || 'Unnamed Employee'}</h3>
                  <div class="employee-status ${statusClass}">${statusText}</div>
                </div>
                <span class="employee-slot-badge">SLOT ${emp.slot || emp.employeeId}</span>
              </div>
              
              <div class="employee-details">
                <div class="employee-detail-row">
                  <span class="detail-label">Employee ID:</span>
                  <span class="detail-value">${emp.employeeId || 'N/A'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Badge Number:</span>
                  <span class="detail-value">${emp.badgeNumber || 'N/A'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">${emp.phone || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">${emp.email || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Position:</span>
                  <span class="detail-value">${emp.position || 'Not set'}</span>
                </div>
                <div class="employee-detail-row">
                  <span class="detail-label">Last Clock:</span>
                  <span class="detail-value">${lastTime}</span>
                </div>
              </div>
              
              <div class="employee-actions">
                <button class="btn-edit" onclick="editEmployee('${emp.id}')">‚úèÔ∏è Edit Details</button>
                <button class="btn-view" onclick="viewEmployeeHistory('${emp.id}')">üìä View History</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error("Error loading employees:", error);
        document.getElementById('employeesGrid').innerHTML = 
          '<div class="no-employees" style="color: #e53e3e;">Error loading employees: ' + error.message + '</div>';
      }
    }

    async function editEmployee(employeeId) {
      try {
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        const staffDoc = await getDoc(staffRef);
        
        if (!staffDoc.exists()) {
          alert('Employee not found');
          return;
        }

        const emp = staffDoc.data();
        
        const modal = `
          <div class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-employee" onclick="event.stopPropagation()">
              <h2>Edit Employee Details</h2>
              <form id="employeeEditForm" onsubmit="saveEmployee(event, '${employeeId}')">
                <div class="form-group">
                  <label>Employee Name*</label>
                  <input type="text" name="employeeName" value="${emp.employeeName || ''}" required>
                </div>
                
                <div class="form-group">
                  <label>Slot Number</label>
                  <input type="text" name="slot" value="${emp.slot || ''}" readonly>
                </div>
                
                <div class="form-group">
                  <label>Badge Number</label>
                  <input type="text" name="badgeNumber" value="${emp.badgeNumber || ''}" readonly>
                </div>
                
                <div class="form-group">
                  <label>Phone Number</label>
                  <input type="tel" name="phone" value="${emp.phone || ''}" placeholder="+27 XX XXX XXXX">
                </div>
                
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" name="email" value="${emp.email || ''}" placeholder="employee@example.com">
                </div>
                
                <div class="form-group">
                  <label>Position/Title</label>
                  <input type="text" name="position" value="${emp.position || ''}" placeholder="e.g., Technician, Manager">
                </div>
                
                <div class="form-group">
                  <label>Department</label>
                  <input type="text" name="department" value="${emp.department || ''}" placeholder="e.g., Production, Sales">
                </div>
                
                <div class="form-group">
                  <label>ID Number</label>
                  <input type="text" name="idNumber" value="${emp.idNumber || ''}" placeholder="SA ID Number">
                </div>
                
                <div class="form-group">
                  <label>Address</label>
                  <textarea name="address" placeholder="Full address">${emp.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                  <label>Hire Date</label>
                  <input type="date" name="hireDate" value="${emp.hireDate || ''}">
                </div>
                
                <div class="form-group">
                  <label>Hourly Rate (ZAR)</label>
                  <input type="number" name="hourlyRate" value="${emp.hourlyRate || ''}" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                  <label>Notes</label>
                  <textarea name="notes" placeholder="Additional notes or comments">${emp.notes || ''}</textarea>
                </div>
                
                <div class="modal-actions">
                  <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                  <button type="submit" class="btn-save">üíæ Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (error) {
        console.error("Error editing employee:", error);
        alert('Error: ' + error.message);
      }
    }

    async function saveEmployee(event, employeeId) {
      event.preventDefault();
      
      try {
        const form = event.target;
        const formData = new FormData(form);
        
        const employeeData = {
          employeeName: formData.get('employeeName'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          position: formData.get('position'),
          department: formData.get('department'),
          idNumber: formData.get('idNumber'),
          address: formData.get('address'),
          hireDate: formData.get('hireDate'),
          hourlyRate: parseFloat(formData.get('hourlyRate')) || 0,
          notes: formData.get('notes'),
          updatedAt: new Date().toISOString()
        };
        
        // Update Firebase
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        await setDoc(staffRef, employeeData, { merge: true });
        
        console.log("Employee updated successfully");
        
        // Close modal
        closeModal();
        
        // Reload employees
        await loadEmployees();
        
        alert('Employee details updated successfully!');
        
      } catch (error) {
        console.error("Error saving employee:", error);
        alert('Error saving: ' + error.message);
      }
    }

    function closeModal(event) {
      if (event && event.target.classList.contains('modal-overlay')) {
        event.target.remove();
      } else {
        document.querySelector('.modal-overlay')?.remove();
      }
    }

    async function viewEmployeeHistory(employeeId) {
      alert('Employee history view coming soon!');
      // TODO: Implement attendance history view
    }

    // Make functions globally available
    window.editEmployee = editEmployee;
    window.saveEmployee = saveEmployee;
    window.closeModal = closeModal;
    window.viewEmployeeHistory = viewEmployeeHistory;

    // ============================================
    // TIMECARD MODULE FUNCTIONS
    // ============================================
    
    async function initTimecard() {
      try {
        // Load employee list for dropdown
        const staffRef = collection(db, "businesses", businessId, "staff");
        const statusRef = collection(db, "businesses", businessId, "status");
        
        const [staffSnap, statusSnap] = await Promise.all([
          getDocs(staffRef),
          getDocs(statusRef)
        ]);

        // Create a map of employees with lastClockTime
        const statusMap = new Map();
        statusSnap.forEach(doc => {
          const status = doc.data();
          if (status.lastClockTime) {
            statusMap.set(doc.id, status);
          }
        });

        // Filter and populate employee dropdown
        const employeeSelect = document.getElementById('employeeSelect');
        employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
        
        const employees = [];
        staffSnap.forEach(doc => {
          const staff = doc.data();
          const status = statusMap.get(doc.id);
          
          if (status && status.lastClockTime) {
            employees.push({
              id: doc.id,
              name: staff.employeeName,
              slot: staff.slot
            });
          }
        });

        // Sort by slot
        employees.sort((a, b) => (a.slot || 0) - (b.slot || 0));

        // Add to dropdown
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.id;
          option.textContent = `${emp.name} (Slot ${emp.slot || emp.id})`;
          employeeSelect.appendChild(option);
        });

        // Set default month to current month
        const now = new Date();
        const monthInput = document.getElementById('monthSelect');
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      } catch (error) {
        console.error("Error initializing timecard:", error);
        alert('Error loading timecard: ' + error.message);
      }
    }

    async function loadTimecard() {
      const employeeId = document.getElementById('employeeSelect').value;
      const month = document.getElementById('monthSelect').value;
      const display = document.getElementById('timecardDisplay');

      if (!employeeId || !month) {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Select an employee and month to view timecard</div>';
        return;
      }

      try {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Loading timecard...</div>';

        // Get employee info
        const staffRef = doc(db, "businesses", businessId, "staff", employeeId);
        const staffDoc = await getDoc(staffRef);
        const employee = staffDoc.data();

        // Parse month
        const [year, monthNum] = month.split('-');
        const monthDate = new Date(year, monthNum - 1, 1);
        const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        // Get all days in month
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const dailyRecords = [];

        // Get business schedule and settings
        const businessRef = doc(db, "businesses", businessId);
        const businessDoc = await getDoc(businessRef);
        const businessData = businessDoc.data();
        const schedule = businessData?.schedule || {};
        const publicHolidays = businessData?.publicHolidays || [];

        // ‚ö° OPTIMIZED: Use pre-calculated timesheets instead of raw events
        const timesheetsRef = collection(db, "businesses", businessId, "employee_timesheets", employeeId, "daily_sheets");
        const timesheetsSnap = await getDocs(timesheetsRef);
        
        // Create a map of date -> timesheet data
        const timesheetMap = new Map();
        timesheetsSnap.forEach(doc => {
          const data = doc.data();
          if (data.date && data.date.startsWith(`${year}-${String(monthNum).padStart(2, '0')}`)) {
            timesheetMap.set(data.date, data);
          }
        });

        // Build daily records array for all days in month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, monthNum - 1, day, 12, 0, 0);
          const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          const fullDayName = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
          
          // Check if this day is configured as a working day
          const daySchedule = schedule[fullDayName];
          const isWorkingDay = daySchedule?.enabled || false;
          const isPublicHoliday = publicHolidays.includes(dateStr);

          const timesheet = timesheetMap.get(dateStr);
          
          if (timesheet && timesheet.clockEvents && timesheet.clockEvents.length > 0) {
            // Use pre-calculated data from timesheets
            const clockIns = timesheet.clockEvents
              .filter(e => e.type === 'clock-in')
              .map(e => new Date(e.timestamp));
            
            const clockOuts = timesheet.clockEvents
              .filter(e => e.type === 'clock-out')
              .map(e => new Date(e.timestamp));

            const overtime = Math.max(0, (timesheet.totalHours || 0) - (daySchedule?.scheduledHours || 8));

            dailyRecords.push({
              date: dateStr,
              day: day,
              dayName: dayName,
              fullDayName: fullDayName,
              isWorkingDay: isWorkingDay,
              isPublicHoliday: isPublicHoliday,
              daySchedule: daySchedule,
              clockIns: clockIns,
              clockOuts: clockOuts,
              totalHours: timesheet.totalHours || 0,
              overtime: overtime,
              hasData: true
            });
          } else {
            // No data for this day - determine status
            dailyRecords.push({
              date: dateStr,
              day: day,
              dayName: dayName,
              fullDayName: fullDayName,
              isWorkingDay: isWorkingDay,
              isPublicHoliday: isPublicHoliday,
              daySchedule: daySchedule,
              clockIns: [],
              clockOuts: [],
              totalHours: 0,
              overtime: 0,
              hasData: false
            });
          }
        }

        // Calculate totals
        const totalHours = dailyRecords.reduce((sum, record) => sum + record.totalHours, 0);
        const totalOvertime = dailyRecords.reduce((sum, record) => sum + record.overtime, 0);
        const daysWorked = dailyRecords.filter(r => r.hasData).length;

        // Render timecard in business format
        display.innerHTML = `
          <div class="timecard-header">
            <h3>${employee.employeeName} - ${monthName}</h3>
            <p>Slot ${employee.slot || employeeId} ‚Ä¢ Badge ${employee.badgeNumber || 'N/A'}</p>
          </div>

          <div class="timecard-table-wrapper">
            <table class="timecard-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Start</th>
                  <th>Stop</th>
                  <th>Shift</th>
                  <th>Description</th>
                  <th>Hours</th>
                  <th>Lunch</th>
                  <th>Tea</th>
                  <th>Breaks</th>
                  <th>Target</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${dailyRecords.map(record => {
                  const clockInTime = record.clockIns.length > 0 
                    ? record.clockIns[0].toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })
                    : '00:00';
                  const clockOutTime = record.clockOuts.length > 0
                    ? record.clockOuts[record.clockOuts.length - 1].toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })
                    : '00:00';
                  const hours = record.totalHours > 0 ? record.totalHours.toFixed(2) : '00:00';
                  
                  // Determine shift and description based on schedule
                  let shift = '-';
                  let description = 'DAY OFF';
                  
                  if (record.isPublicHoliday) {
                    description = 'PUBLIC HOLIDAY';
                    shift = '-';
                  } else if (record.isWorkingDay && record.daySchedule) {
                    shift = `${record.daySchedule.startTime || '08:00'}-${record.daySchedule.endTime || '17:00'}`;
                    if (record.hasData) {
                      description = 'NORMAL TIME';
                    } else {
                      description = 'ABSENT';
                    }
                  } else if (!record.isWorkingDay) {
                    description = 'DAY OFF';
                    shift = '-';
                  }
                  
                  const rowClass = !record.isWorkingDay || record.isPublicHoliday ? 'weekend' : '';

                  return `
                    <tr class="${rowClass}">
                      <td>${year}-${String(monthNum).padStart(2, '0')}-${String(record.day).padStart(2, '0')}</td>
                      <td>${record.dayName}</td>
                      <td>${clockInTime}</td>
                      <td>${clockOutTime}</td>
                      <td>${shift}</td>
                      <td>${description}</td>
                      <td>${hours}</td>
                      <td>01:00</td>
                      <td>00:00</td>
                      <td>00:00</td>
                      <td>08:00</td>
                      <td>${hours}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="timecard-summary">
            <div class="summary-grid">
              <div class="summary-section">
                <div class="summary-item">
                  <span class="summary-label">Normal</span>
                  <span class="summary-value">${(totalHours - totalOvertime).toFixed(2)}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">OT 1.25</span>
                  <span class="summary-value">${totalOvertime.toFixed(2)}</span>
                </div>
              </div>
              
              <div class="summary-section">
                <div class="summary-item">
                  <span class="summary-label">Breaks</span>
                  <span class="summary-value">00:00</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Lunch</span>
                  <span class="summary-value">${(daysWorked * 1).toFixed(2)}:00</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Tea</span>
                  <span class="summary-value">00:00</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Shifts Worked</span>
                  <span class="summary-value">${daysWorked}</span>
                </div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error("Error loading timecard:", error);
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #e53e3e;">Error loading timecard: ' + error.message + '</div>';
      }
    }

    function printTimecard() {
      // Update print date before printing
      const printDateEl = document.getElementById('printDate');
      if (printDateEl) {
        const now = new Date();
        printDateEl.textContent = now.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      window.print();
    }

    // Make timecard functions globally available
    window.loadTimecard = loadTimecard;
    window.printTimecard = printTimecard;
    window.initTimecard = initTimecard;

    // ============================================
    // REPORTS MODULE FUNCTIONS
    // ============================================
    
    async function initReports() {
      try {
        // Set default month to current month
        const now = new Date();
        const monthInput = document.getElementById('reportMonth');
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        // Load reports for current month
        await loadReports();
      } catch (error) {
        console.error("Error initializing reports:", error);
        alert('Error loading reports: ' + error.message);
      }
    }

    async function loadReports() {
      const month = document.getElementById('reportMonth').value;
      const display = document.getElementById('reportsContent');

      if (!month) {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Select a month to generate reports</div>';
        return;
      }

      try {
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">Generating reports...</div>';

        // Parse month
        const [year, monthNum] = month.split('-');
        const monthDate = new Date(year, monthNum - 1, 1);
        const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const daysInMonth = new Date(year, monthNum, 0).getDate();

        // Get all active employees
        const staffRef = collection(db, "businesses", businessId, "staff");
        const statusRef = collection(db, "businesses", businessId, "status");
        
        const [staffSnap, statusSnap] = await Promise.all([
          getDocs(staffRef),
          getDocs(statusRef)
        ]);

        // Create status map
        const statusMap = new Map();
        statusSnap.forEach(doc => {
          const status = doc.data();
          if (status.lastClockTime) {
            statusMap.set(doc.id, status);
          }
        });

        // Get active employees
        const employees = [];
        staffSnap.forEach(doc => {
          const staff = doc.data();
          const status = statusMap.get(doc.id);
          
          if (status && status.lastClockTime) {
            employees.push({
              id: doc.id,
              ...staff
            });
          }
        });

        // Sort by slot
        employees.sort((a, b) => (a.slot || 0) - (b.slot || 0));

        if (employees.length === 0) {
          display.innerHTML = '<div class="no-employees">No employees found. Reports will be available after employees clock in.</div>';
          return;
        }

        // Get business schedule settings
        const businessRef = doc(db, "businesses", businessId);
        const businessDoc = await getDoc(businessRef);
        const businessData = businessDoc.data();
        const schedule = businessData?.schedule || {};
        const publicHolidays = businessData?.publicHolidays || [];

        // Calculate attendance and hours for each employee using pre-calculated timesheets
        const employeeReports = [];
        
        for (const employee of employees) {
          let totalHours = 0;
          let totalOvertime = 0;
          let daysWorked = 0;
          let daysAbsent = 0;
          let daysLate = 0;

          // ‚ö° OPTIMIZED: Load all timesheets for this employee in one query
          const timesheetsRef = collection(db, "businesses", businessId, "employee_timesheets", employee.id, "daily_sheets");
          const timesheetsSnap = await getDocs(timesheetsRef);
          
          // Filter timesheets for current month
          const monthPrefix = `${year}-${String(monthNum).padStart(2, '0')}`;
          timesheetsSnap.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(monthPrefix)) {
              // Use pre-calculated hours
              totalHours += data.totalHours || 0;
              totalOvertime += data.overtimeHours || 0;
              
              if (data.totalHours > 0) {
                daysWorked++;
              }
              
              // Check if late (first clock-in after scheduled start)
              if (data.clockEvents && data.clockEvents.length > 0) {
                const firstClockIn = data.clockEvents.find(e => e.type === 'clock-in');
                if (firstClockIn) {
                  const clockInTime = new Date(firstClockIn.timestamp);
                  const date = new Date(data.date);
                  const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                  const daySchedule = schedule[dayOfWeek];
                  
                  if (daySchedule && daySchedule.startTime) {
                    const scheduledStart = new Date(data.date + 'T' + daySchedule.startTime);
                    if (clockInTime > scheduledStart) {
                      daysLate++;
                    }
                  }
                }
              }
            }
          });

          // Calculate expected workdays from schedule
          let expectedWorkdays = 0;
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, monthNum - 1, day);
            const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
            const daySchedule = schedule[dayOfWeek];
            const isPublicHoliday = publicHolidays.includes(dateStr);
            
            if (daySchedule && daySchedule.enabled && !isPublicHoliday) {
              expectedWorkdays++;
            }
          }

          daysAbsent = Math.max(0, expectedWorkdays - daysWorked);
          const attendanceRate = expectedWorkdays > 0 ? ((daysWorked / expectedWorkdays) * 100).toFixed(1) : 0;
          const regularHours = totalHours - totalOvertime;
          const hourlyRate = employee.hourlyRate || 0;
          const regularPay = regularHours * hourlyRate;
          const overtimePay = totalOvertime * hourlyRate * 1.5; // 1.5x for overtime
          const totalPay = regularPay + overtimePay;

          employeeReports.push({
            employee,
            daysWorked,
            daysAbsent,
            daysLate,
            attendanceRate,
            totalHours,
            regularHours,
            totalOvertime,
            hourlyRate,
            regularPay,
            overtimePay,
            totalPay,
            expectedWorkdays
          });
        }

        // Calculate overall statistics
        const totalEmployees = employeeReports.length;
        const totalDaysWorked = employeeReports.reduce((sum, r) => sum + r.daysWorked, 0);
        const totalHoursWorked = employeeReports.reduce((sum, r) => sum + r.totalHours, 0);
        const totalOvertimeHours = employeeReports.reduce((sum, r) => sum + r.totalOvertime, 0);
        const totalPayroll = employeeReports.reduce((sum, r) => sum + r.totalPay, 0);
        const avgAttendanceRate = totalEmployees > 0 
          ? (employeeReports.reduce((sum, r) => sum + parseFloat(r.attendanceRate), 0) / totalEmployees).toFixed(1)
          : 0;

        // Render reports
        display.innerHTML = `
          <!-- Report Header -->
          <div class="report-header">
            <h3>üìä Monthly Report - ${monthName}</h3>
            <p>Generated on ${new Date().toLocaleString()}</p>
          </div>

          <!-- Overall Statistics -->
          <div class="report-stats">
            <div class="stat-card">
              <div class="stat-label">Total Employees</div>
              <div class="stat-value">${totalEmployees}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Hours Worked</div>
              <div class="stat-value">${totalHoursWorked.toFixed(1)}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Overtime Hours</div>
              <div class="stat-value">${totalOvertimeHours.toFixed(1)}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Attendance</div>
              <div class="stat-value">${avgAttendanceRate}%</div>
            </div>
            <div class="stat-card highlight">
              <div class="stat-label">Total Payroll</div>
              <div class="stat-value">R ${totalPayroll.toFixed(2)}</div>
            </div>
          </div>

          <!-- Attendance Summary Table -->
          <div class="report-section">
            <h4>Attendance Summary</h4>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Slot</th>
                  <th>Days Worked</th>
                  <th>Days Absent</th>
                  <th>Times Late</th>
                  <th>Attendance %</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${employeeReports.map(report => {
                  const status = parseFloat(report.attendanceRate) >= 95 ? '‚úÖ Excellent' :
                                parseFloat(report.attendanceRate) >= 85 ? 'üëç Good' :
                                parseFloat(report.attendanceRate) >= 70 ? '‚ö†Ô∏è Fair' : '‚ùå Poor';
                  return `
                    <tr>
                      <td>${report.employee.employeeName}</td>
                      <td>${report.employee.slot || report.employee.id}</td>
                      <td>${report.daysWorked}</td>
                      <td>${report.daysAbsent}</td>
                      <td>${report.daysLate}</td>
                      <td>${report.attendanceRate}%</td>
                      <td>${status}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <!-- Hours and Payroll Report -->
          <div class="report-section">
            <h4>Hours & Payroll Report</h4>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Slot</th>
                  <th>Regular Hours</th>
                  <th>Overtime Hours</th>
                  <th>Total Hours</th>
                  <th>Hourly Rate</th>
                  <th>Regular Pay</th>
                  <th>OT Pay (1.5x)</th>
                  <th>Total Pay</th>
                </tr>
              </thead>
              <tbody>
                ${employeeReports.map(report => `
                  <tr>
                    <td>${report.employee.employeeName}</td>
                    <td>${report.employee.slot || report.employee.id}</td>
                    <td>${report.regularHours.toFixed(2)}</td>
                    <td>${report.totalOvertime.toFixed(2)}</td>
                    <td><strong>${report.totalHours.toFixed(2)}</strong></td>
                    <td>R ${report.hourlyRate.toFixed(2)}</td>
                    <td>R ${report.regularPay.toFixed(2)}</td>
                    <td>R ${report.overtimePay.toFixed(2)}</td>
                    <td><strong>R ${report.totalPay.toFixed(2)}</strong></td>
                  </tr>
                `).join('')}
                <tr class="total-row">
                  <td colspan="2"><strong>TOTALS</strong></td>
                  <td><strong>${employeeReports.reduce((sum, r) => sum + r.regularHours, 0).toFixed(2)}</strong></td>
                  <td><strong>${totalOvertimeHours.toFixed(2)}</strong></td>
                  <td><strong>${totalHoursWorked.toFixed(2)}</strong></td>
                  <td>-</td>
                  <td><strong>R ${employeeReports.reduce((sum, r) => sum + r.regularPay, 0).toFixed(2)}</strong></td>
                  <td><strong>R ${employeeReports.reduce((sum, r) => sum + r.overtimePay, 0).toFixed(2)}</strong></td>
                  <td><strong>R ${totalPayroll.toFixed(2)}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Payrun Summary Section -->
          <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            ${(() => {
              // Calculate potential payrun first for saved revenue calculation
              let potentialHours = 0;
              let potentialPay = 0;
              let totalExpectedDays = 0;

              employeeReports.forEach(emp => {
                const expectedWorkdays = emp.expectedWorkdays || 0;
                totalExpectedDays += expectedWorkdays;
                
                let totalScheduledHours = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                  const date = new Date(year, monthNum - 1, day);
                  const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                  const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                  const daySchedule = schedule[dayOfWeek];
                  const isPublicHoliday = publicHolidays.includes(dateStr);
                  
                  if (daySchedule && daySchedule.enabled && !isPublicHoliday) {
                    const start = daySchedule.startTime || '08:00';
                    const end = daySchedule.endTime || '17:00';
                    const [startH, startM] = start.split(':').map(Number);
                    const [endH, endM] = end.split(':').map(Number);
                    const dayHours = (endH + endM/60) - (startH + startM/60);
                    totalScheduledHours += dayHours;
                  }
                }
                
                potentialHours += totalScheduledHours;
                const hourlyRate = emp.hourlyRate || 0;
                potentialPay += totalScheduledHours * hourlyRate;
              });

              const savedRevenue = potentialPay - totalPayroll;

              return `
            <div style="background: #fff3cd; padding: 2rem; border-radius: 12px; border: 2px solid #ffc107;">
              <h3 style="margin: 0 0 1rem 0; color: #856404; font-size: 1.3rem;">üí∞ Current Payrun (Actual)</h3>
              <div style="display: grid; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #ffeaa7;">
                  <span style="color: #856404; font-weight: 600;">Total Employees:</span>
                  <span style="font-size: 1.2rem; font-weight: bold; color: #856404;">${employees.length}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #ffeaa7;">
                  <span style="color: #856404; font-weight: 600;">Total Hours Worked:</span>
                  <span style="font-size: 1.2rem; font-weight: bold; color: #856404;">${totalHoursWorked.toFixed(2)} hrs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #ffeaa7;">
                  <span style="color: #856404; font-weight: 600;">Days Worked:</span>
                  <span style="font-size: 1.2rem; font-weight: bold; color: #856404;">${employeeReports.reduce((sum, r) => sum + r.daysWorked, 0)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #ffeaa7;">
                  <span style="color: #856404; font-weight: 600;">Revenue Saved (Absences):</span>
                  <span style="font-size: 1.2rem; font-weight: bold; color: #28a745;">R ${savedRevenue.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 2px solid #ffc107;">
                  <span style="color: #856404; font-weight: 700; font-size: 1.1rem;">TOTAL PAYRUN:</span>
                  <span style="font-size: 1.5rem; font-weight: bold; color: #856404;">R ${totalPayroll.toFixed(2)}</span>
                </div>
              </div>
            </div>

            <div style="background: #d4edda; padding: 2rem; border-radius: 12px; border: 2px solid #28a745;">
              <h3 style="margin: 0 0 1rem 0; color: #155724; font-size: 1.3rem;">üéØ Potential Payrun (100% Attendance)</h3>
              <div style="display: grid; gap: 1rem;">
                ${(() => {
                  const missedOpportunity = potentialPay - totalPayroll;

                  return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #b7e4c7;">
                      <span style="color: #155724; font-weight: 600;">Potential Hours:</span>
                      <span style="font-size: 1.2rem; font-weight: bold; color: #155724;">${potentialHours.toFixed(2)} hrs</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #b7e4c7;">
                      <span style="color: #155724; font-weight: 600;">Expected Days:</span>
                      <span style="font-size: 1.2rem; font-weight: bold; color: #155724;">${totalExpectedDays}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #b7e4c7;">
                      <span style="color: #155724; font-weight: 600;">Hours Lost to Absence:</span>
                      <span style="font-size: 1.2rem; font-weight: bold; color: #d9534f;">${(potentialHours - totalHoursWorked).toFixed(2)} hrs</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 2px solid #28a745;">
                      <span style="color: #155724; font-weight: 700; font-size: 1.1rem;">POTENTIAL PAYRUN:</span>
                      <span style="font-size: 1.5rem; font-weight: bold; color: #155724;">R ${potentialPay.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; background: #f8d7da; padding: 0.75rem; border-radius: 6px; margin-top: 1rem;">
                      <span style="color: #721c24; font-weight: 600;">Lost Revenue:</span>
                      <span style="font-size: 1.3rem; font-weight: bold; color: #721c24;">R ${missedOpportunity.toFixed(2)}</span>
                    </div>
                  `;
                })()}
              </div>
            </div>
            `;
            })()}
          </div>
        `;

      } catch (error) {
        console.error("Error loading reports:", error);
        display.innerHTML = '<div style="text-align: center; padding: 3rem; color: #e53e3e;">Error loading reports: ' + error.message + '</div>';
      }
    }

    function printReports() {
      window.print();
    }

    // Make reports functions globally available
    window.loadReports = loadReports;
    window.printReports = printReports;
    window.initReports = initReports;

    // ============================================
    // DOWNLOADS MODULE FUNCTIONS
    // ============================================
    
    async function loadDownloads() {
      const monitorUrl = `${window.location.origin}/pages/monitor-app.html?businessId=${businessId}`;
      
      const downloadsHTML = `
        <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
          <h2 style="margin-bottom: 2rem; font-size: 1.8rem; color: #333;">üì• Downloads & Apps</h2>
          
          <!-- Monitor App Card -->
          <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: start; gap: 1.5rem;">
              <div style="font-size: 4rem;">üì±</div>
              <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; color: #667eea;">Monitor Mode App</h3>
                <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.6;">
                  Dedicated app for Android tablets/phones that displays live employee attendance status. 
                  Perfect for mounting on office walls or reception desks.
                </p>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Features:</h4>
                  <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                    <li>Real-time attendance updates</li>
                    <li>Large, easy-to-read employee cards</li>
                    <li>Shows IN/OUT status with timestamps</li>
                    <li>Auto-refresh every 30 seconds</li>
                    <li>Works offline (cached data)</li>
                    <li>Full-screen mode support</li>
                  </ul>
                </div>

                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                  <h4 style="margin: 0 0 0.5rem 0; font-size: 0.95rem; color: #92400e;">üì± Installation Instructions for Android:</h4>
                  <ol style="margin: 0.5rem 0 0 1.2rem; font-size: 0.9rem; line-height: 1.8; color: #78350f;">
                    <li><strong>Scan QR Code below</strong> or click "Open Monitor App" button</li>
                    <li>On your Android device, tap the <strong>menu (‚ãÆ)</strong> in browser</li>
                    <li>Select <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
                    <li>Name it "Attendance Monitor" and tap Add</li>
                    <li>App icon will appear on your home screen - tap to open</li>
                    <li>Enable full-screen mode from app settings</li>
                  </ol>
                </div>

                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1.5rem;">
                  <button onclick="window.open('${monitorUrl}', '_blank')" 
                          style="padding: 0.75rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    üöÄ Open Monitor App
                  </button>
                  
                  <button onclick="copyMonitorUrl()" 
                          style="padding: 0.75rem 1.5rem; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    üìã Copy Link
                  </button>
                </div>

                <!-- QR Code -->
                <div style="margin-top: 1.5rem;">
                  <p style="font-weight: 600; margin-bottom: 0.5rem;">üì∏ Scan with phone camera:</p>
                  <div id="qrcode" style="background: white; padding: 1rem; display: inline-block; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                </div>

                <!-- Share Link -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                  <p style="font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Monitor App Link:</p>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" id="monitorUrlInput" value="${monitorUrl}" readonly
                           style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Coming Soon Card -->
          <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 0.7;">
            <div style="display: flex; align-items: start; gap: 1.5rem;">
              <div style="font-size: 4rem;">üöß</div>
              <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; color: #666;">More Apps Coming Soon</h3>
                <p style="margin: 0; color: #666; line-height: 1.6;">
                  We're working on additional apps including:
                </p>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                  <li>Employee Self-Service Mobile App</li>
                  <li>Manager Dashboard App</li>
                  <li>Desktop Time Clock App</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;

      // Insert HTML into dashboard view (replace the modules grid)
      const dashboardView = document.getElementById('dashboardView');
      if (dashboardView) {
        dashboardView.innerHTML = downloadsHTML;

        // Generate QR Code
        loadQRCodeLibrary().then(() => {
          new QRCode(document.getElementById('qrcode'), {
            text: monitorUrl,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
          });
        });
      }
    }

    function loadQRCodeLibrary() {
      return new Promise((resolve) => {
        if (window.QRCode) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        script.onload = resolve;
        document.head.appendChild(script);
      });
    }

    window.copyMonitorUrl = function() {
      const input = document.getElementById('monitorUrlInput');
      input.select();
      document.execCommand('copy');
      alert('‚úÖ Monitor app link copied to clipboard!');
    };

    window.loadDownloads = loadDownloads;

    // ============================================
    // SETTINGS MODULE FUNCTIONS
    // ============================================
    
    async function loadSettings() {
      try {
        // Load business data
        const businessRef = doc(db, "businesses", businessId);
        const businessDoc = await getDoc(businessRef);
        
        if (businessDoc.exists()) {
          const data = businessDoc.data();
          
          // Business Info
          document.getElementById('businessName').value = data.businessName || '';
          document.getElementById('businessPhone').value = data.phone || data.phoneNumber || '';
          document.getElementById('businessEmail').value = data.adminEmail || '';
          document.getElementById('businessCurrency').value = data.currency || 'R';
          
          // Working Days with Schedule
          const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
          days.forEach(day => {
            const dayData = data.schedule?.[day] || {};
            document.getElementById(day).checked = dayData.enabled || data[day] || false;
            document.getElementById(day + 'Start').value = dayData.startTime || '08:00';
            document.getElementById(day + 'End').value = dayData.endTime || (day === 'saturday' ? '14:30' : '17:00');
            document.getElementById(day + 'Rate').value = dayData.payRate || '';
          });
          
          // Public Holidays
          document.getElementById('publicHolidays').value = (data.publicHolidays || []).join('\n');
          
          // Working Hours
          document.getElementById('breakDuration').value = data.breakDuration || 60;
          document.getElementById('overtimeRule').value = data.overtimeRule || 'none';
          document.getElementById('overtimeMultiplier').value = data.overtimeMultiplier || 1.5;
        }
        
        // Setup form handlers
        document.getElementById('businessInfoForm').addEventListener('submit', saveBusinessInfo);
        document.getElementById('workingDaysForm').addEventListener('submit', saveWorkingDays);
        document.getElementById('publicHolidaysForm').addEventListener('submit', savePublicHolidays);
        document.getElementById('workingHoursForm').addEventListener('submit', saveWorkingHours);
        
      } catch (error) {
        console.error("Error loading settings:", error);
        alert('Error loading settings: ' + error.message);
      }
    }
    
    async function saveBusinessInfo(e) {
      e.preventDefault();
      try {
        const businessRef = doc(db, "businesses", businessId);
        await setDoc(businessRef, {
          businessName: document.getElementById('businessName').value,
          phone: document.getElementById('businessPhone').value,
          adminEmail: document.getElementById('businessEmail').value,
          currency: document.getElementById('businessCurrency').value,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        alert('‚úÖ Business information saved successfully!');
      } catch (error) {
        console.error("Error saving business info:", error);
        alert('Error saving: ' + error.message);
      }
    }
    
    async function saveWorkingDays(e) {
      e.preventDefault();
      try {
        const businessRef = doc(db, "businesses", businessId);
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const schedule = {};
        
        days.forEach(day => {
          schedule[day] = {
            enabled: document.getElementById(day).checked,
            startTime: document.getElementById(day + 'Start').value,
            endTime: document.getElementById(day + 'End').value,
            payRate: parseFloat(document.getElementById(day + 'Rate').value) || 0
          };
        });
        
        await setDoc(businessRef, {
          schedule: schedule,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        alert('‚úÖ Working schedule saved successfully!');
      } catch (error) {
        console.error("Error saving working days:", error);
        alert('Error saving: ' + error.message);
      }
    }
    
    async function savePublicHolidays(e) {
      e.preventDefault();
      try {
        const businessRef = doc(db, "businesses", businessId);
        const holidaysText = document.getElementById('publicHolidays').value;
        const holidays = holidaysText.split('\n').map(h => h.trim()).filter(h => h.length > 0);
        
        await setDoc(businessRef, {
          publicHolidays: holidays,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        alert('‚úÖ Public holidays saved successfully!');
      } catch (error) {
        console.error("Error saving holidays:", error);
        alert('Error saving: ' + error.message);
      }
    }
    
    async function saveWorkingHours(e) {
      e.preventDefault();
      try {
        const businessRef = doc(db, "businesses", businessId);
        await setDoc(businessRef, {
          breakDuration: parseInt(document.getElementById('breakDuration').value),
          overtimeRule: document.getElementById('overtimeRule').value,
          overtimeMultiplier: parseFloat(document.getElementById('overtimeMultiplier').value),
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        alert('‚úÖ Working hours rules saved successfully!');
      } catch (error) {
        console.error("Error saving working hours:", error);
        alert('Error saving: ' + error.message);
      }
    }

    // Debug functions for testing
    async function addTestEmployee() {
      try {
        const staffRef = collection(db, "businesses", businessId, "staff");
        const slotRef = doc(staffRef, "1");
        await setDoc(slotRef, {
          employeeId: "1",
          employeeName: "John Smith",
          badgeNumber: "1001",
          deviceId: "device_1",
          slot: 1,
          active: true,
          assignedAt: new Date().toISOString(),
          createdAt: new Date().toISOString()
        });
        console.log("Test employee added (IN)");
        loadMonitorData();
      } catch (error) {
        console.error("Error adding test employee:", error);
        alert("Error: " + error.message);
      }
    }

    async function addTestEmployeeOut() {
      try {
        const staffRef = collection(db, "businesses", businessId, "staff");
        const slotRef = doc(staffRef, "2");
        await setDoc(slotRef, {
          employeeId: "2",
          employeeName: "Jane Doe",
          badgeNumber: "1002",
          deviceId: "device_2",
          slot: 2,
          active: false,
          assignedAt: new Date().toISOString(),
          createdAt: new Date().toISOString(),
          outTime: new Date().getTime()
        });
        console.log("Test employee added (OUT)");
        loadMonitorData();
      } catch (error) {
        console.error("Error adding test employee:", error);
        alert("Error: " + error.message);
      }
    }

    async function clearAllStaff() {
      try {
        if (!confirm("Are you sure? This will clear all staff data.")) return;
        
        const staffRef = collection(db, "businesses", businessId, "staff");
        const staffSnap = await getDocs(staffRef);
        
        for (let doc of staffSnap.docs) {
          await deleteDoc(doc.ref);
        }
        console.log("All staff cleared");
        loadMonitorData();
      } catch (error) {
        console.error("Error clearing staff:", error);
        alert("Error: " + error.message);
      }
    }
  </script>
</body>
</html>
