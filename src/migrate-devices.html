<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migrate Devices to Global Collection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #2563eb;
    }
    #status {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 6px;
      max-height: 400px;
      overflow-y: auto;
    }
    #status p {
      margin: 0.5rem 0;
      font-size: 0.875rem;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”„ Device Migration Tool</h1>
    <p>This tool will migrate all devices from business subcollections to a global devices collection.</p>
    <button id="migrateBtn">Start Migration</button>
    <div id="status"></div>
  </div>

  <script type="module">
    import { collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from "./config/firebase.js";

    document.getElementById('migrateBtn').addEventListener('click', async () => {
      const statusDiv = document.getElementById('status');
      const btn = document.getElementById('migrateBtn');
      btn.disabled = true;
      btn.textContent = 'Migrating...';
      
      statusDiv.innerHTML = '<p class="info">Starting migration...</p>';

      try {
        // Get all businesses
        const businessesRef = collection(db, "businesses");
        const businessesSnap = await getDocs(businessesRef);
        
        let migratedCount = 0;
        let skippedCount = 0;
        let errorCount = 0;

        statusDiv.innerHTML += `<p class="info">Found ${businessesSnap.size} businesses</p>`;

        for (const businessDoc of businessesSnap.docs) {
          const businessId = businessDoc.id;
          const businessData = businessDoc.data();
          
          statusDiv.innerHTML += `<p>Checking business: <strong>${businessData.businessName || businessId}</strong></p>`;

          // Get devices from this business
          const devicesRef = collection(db, "businesses", businessId, "devices");
          const devicesSnap = await getDocs(devicesRef);

          statusDiv.innerHTML += `<p class="info">Found ${devicesSnap.size} devices in this business</p>`;

          for (const deviceDoc of devicesSnap.docs) {
            try {
              const deviceId = deviceDoc.id;
              const deviceData = deviceDoc.data();

              // Check if device already exists in global collection
              const globalDeviceRef = doc(db, "devices", deviceId);
              const existingDevice = await getDoc(globalDeviceRef);
              
              if (existingDevice.exists()) {
                statusDiv.innerHTML += `<p style="color: orange;">âš  Device ${deviceId} already exists in global collection, skipping</p>`;
                skippedCount++;
              } else {
                // Copy to global collection
                await setDoc(globalDeviceRef, deviceData);
                
                statusDiv.innerHTML += `<p class="success">âœ“ Migrated device: ${deviceId} (${deviceData.deviceName || 'Unnamed'})</p>`;
                migratedCount++;
              }

            } catch (error) {
              statusDiv.innerHTML += `<p class="error">âœ— Error migrating ${deviceDoc.id}: ${error.message}</p>`;
              errorCount++;
            }
          }
        }

        statusDiv.innerHTML += `<h2>Migration Complete! ðŸŽ‰</h2>`;
        statusDiv.innerHTML += `<p><strong>Migrated:</strong> ${migratedCount} devices</p>`;
        statusDiv.innerHTML += `<p><strong>Skipped:</strong> ${skippedCount} devices</p>`;
        statusDiv.innerHTML += `<p><strong>Errors:</strong> ${errorCount}</p>`;
        statusDiv.innerHTML += `<p class="info"><strong>Note:</strong> Old devices are still in business subcollections for safety. You can remove them manually after verifying the migration worked.</p>`;
        
        btn.textContent = 'Migration Complete âœ“';
        btn.style.background = '#10b981';

      } catch (error) {
        statusDiv.innerHTML += `<p class="error">Migration failed: ${error.message}</p>`;
        console.error(error);
        btn.disabled = false;
        btn.textContent = 'Retry Migration';
      }
    });
  </script>
</body>
</html>
