<!DOCTYPE html>
<html>
<head>
  <title>Fix Business maxEmployees</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    button { padding: 1rem 2rem; font-size: 1rem; cursor: pointer; }
    pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; max-height: 500px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Fix maxEmployees for Businesses</h2>
  <p>This will add the maxEmployees field to any business that doesn't have it.</p>
  <button id="fixBtn">Fix All Businesses</button>
  <pre id="output"></pre>

  <script type="module">
    import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from './config/firebase.js';

    document.getElementById('fixBtn').addEventListener('click', async () => {
      const output = document.getElementById('output');
      const btn = document.getElementById('fixBtn');
      btn.disabled = true;
      output.textContent = 'Starting...\n\n';

      try {
        const businessesSnapshot = await getDocs(collection(db, 'businesses'));
        output.textContent += `Found ${businessesSnapshot.size} businesses\n\n`;

        const planLimits = {
          'Basic': 5,
          'Standard': 10,
          'Premium': 20,
          'Enterprise': 50
        };

        let updated = 0;
        let skipped = 0;

        for (const docSnapshot of businessesSnapshot.docs) {
          const data = docSnapshot.data();
          const businessId = docSnapshot.id;

          if (!data.maxEmployees) {
            const maxEmployees = data.slotsAllowed || planLimits[data.plan] || 5;
            
            output.textContent += `Updating ${businessId}:\n`;
            output.textContent += `  Name: ${data.businessName}\n`;
            output.textContent += `  Email: ${data.email || data.adminEmail}\n`;
            output.textContent += `  Plan: ${data.plan || 'Basic'}\n`;
            output.textContent += `  slotsAllowed: ${data.slotsAllowed || 'not set'}\n`;
            output.textContent += `  Setting maxEmployees: ${maxEmployees}\n\n`;

            await updateDoc(doc(db, 'businesses', businessId), {
              maxEmployees: maxEmployees
            });

            updated++;
          } else {
            output.textContent += `Skipping ${businessId} - maxEmployees already set to ${data.maxEmployees}\n`;
            skipped++;
          }
        }

        output.textContent += `\n=== DONE ===\n`;
        output.textContent += `Updated: ${updated}\n`;
        output.textContent += `Skipped: ${skipped}\n`;

      } catch (error) {
        output.textContent += `\nError: ${error.message}\n`;
        console.error(error);
      }

      btn.disabled = false;
    });
  </script>
</body>
</html>
