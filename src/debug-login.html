<!DOCTYPE html>
<html>
<head>
    <title>Login Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 8px 15px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Login Debug Testing</h1>
    
    <div class="test-section">
        <h3>Step 1: Test Firebase Connection</h3>
        <button onclick="testFirebase()">Test Firebase</button>
        <div id="firebaseResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Test Auth Service Import</h3>
        <button onclick="testAuthImport()">Test Import</button>
        <div id="importResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Admin Login</h3>
        <button onclick="testAdminLogin()">Test Admin Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Test Session Storage</h3>
        <button onclick="testSession()">Check Session</button>
        <div id="sessionResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 5: Test Dashboard Access</h3>
        <button onclick="testDashboard()">Test Dashboard</button>
        <div id="dashboardResult"></div>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script type="module">
        let authService;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        window.clearLog = () => {
            document.getElementById('log').innerHTML = '';
        }

        window.testFirebase = async function() {
            try {
                log('Testing Firebase connection...');
                const { db } = await import('../config/firebase.js');
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const businessesRef = collection(db, "businesses");
                const querySnapshot = await getDocs(businessesRef);
                
                document.getElementById('firebaseResult').innerHTML = `<span class="success">✅ Connected (${querySnapshot.size} businesses)</span>`;
                log(`Firebase connected successfully. Found ${querySnapshot.size} businesses.`, 'success');
            } catch (error) {
                document.getElementById('firebaseResult').innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`Firebase connection failed: ${error.message}`, 'error');
            }
        }

        window.testAuthImport = async function() {
            try {
                log('Testing auth service import...');
                const authModule = await import('../modules/auth/auth.service.js');
                authService = authModule.default;
                
                document.getElementById('importResult').innerHTML = `<span class="success">✅ Auth service imported</span>`;
                log('Auth service imported successfully', 'success');
                log(`Auth service methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(authService)).join(', ')}`);
            } catch (error) {
                document.getElementById('importResult').innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`Auth import failed: ${error.message}`, 'error');
            }
        }

        window.testAdminLogin = async function() {
            try {
                if (!authService) {
                    await testAuthImport();
                }
                
                log('Testing admin login...');
                const result = await authService.adminLogin("info@simplewebhost.co.za", "Azam198419880001#");
                
                document.getElementById('loginResult').innerHTML = `<span class="success">✅ Login successful</span>`;
                log(`Login successful: ${JSON.stringify(result)}`, 'success');
                
                // Check session storage
                log(`Session storage - Role: ${sessionStorage.getItem('userRole')}`);
                log(`Session storage - UserID: ${sessionStorage.getItem('userId')}`);
                log(`Session storage - Email: ${sessionStorage.getItem('userEmail')}`);
                
            } catch (error) {
                document.getElementById('loginResult').innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`Login failed: ${error.message}`, 'error');
            }
        }

        window.testSession = async function() {
            try {
                if (!authService) {
                    await testAuthImport();
                }
                
                log('Testing session storage and auth methods...');
                
                const isAuth = authService.isAuthenticated();
                const role = authService.getUserRole();
                
                const sessionData = {
                    isAuthenticated: isAuth,
                    userRole: role,
                    sessionRole: sessionStorage.getItem('userRole'),
                    sessionUserId: sessionStorage.getItem('userId'),
                    sessionUserEmail: sessionStorage.getItem('userEmail')
                };
                
                document.getElementById('sessionResult').innerHTML = `<span class="success">✅ Session data retrieved</span>`;
                log(`Session data: ${JSON.stringify(sessionData, null, 2)}`, 'success');
                
            } catch (error) {
                document.getElementById('sessionResult').innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`Session test failed: ${error.message}`, 'error');
            }
        }

        window.testDashboard = async function() {
            try {
                log('Testing dashboard access...');
                
                // Import dashboard module
                const dashboardModule = await import('../modules/admin/dashboard.js');
                log('Dashboard module imported successfully', 'success');
                
                // Test authentication check
                if (!authService) {
                    await testAuthImport();
                    await testAdminLogin();
                }
                
                const isAuth = authService.isAuthenticated();
                const role = authService.getUserRole();
                
                if (isAuth && role === 'admin') {
                    document.getElementById('dashboardResult').innerHTML = `<span class="success">✅ Dashboard access allowed</span>`;
                    log('Dashboard access test passed', 'success');
                } else {
                    document.getElementById('dashboardResult').innerHTML = `<span class="error">❌ Dashboard access denied</span>`;
                    log(`Dashboard access denied - Auth: ${isAuth}, Role: ${role}`, 'error');
                }
                
            } catch (error) {
                document.getElementById('dashboardResult').innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`Dashboard test failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>