<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSDK Hikvision Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            padding: 8px;
            margin-left: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        #status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        #status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        #logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .plugin-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            margin: 20px 0;
            background: #000;
        }
        #divPlugin {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• WebSDK Hikvision Device Interface</h1>
            <p>Connect to FC4349999 Access Control Terminal</p>
        </div>

        <!-- Device Connection Section -->
        <div class="section">
            <h3>üîå Device Connection</h3>
            <div class="form-group">
                <label>Device IP:</label>
                <input type="text" id="deviceIP" value="192.168.0.114" />
            </div>
            <div class="form-group">
                <label>Port:</label>
                <input type="text" id="devicePort" value="80" />
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="username" value="admin" />
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" value="Azam198419880001" />
            </div>
            <button onclick="connectDevice()" class="success">üîë Connect to Device</button>
            <button onclick="disconnectDevice()" class="danger">üö™ Disconnect</button>
            <button onclick="getDeviceInfo()">‚ÑπÔ∏è Get Device Info</button>
        </div>

        <!-- WebSDK Plugin Container -->
        <div class="section">
            <h3>üì∫ WebSDK Plugin</h3>
            <div class="plugin-container">
                <div id="divPlugin"></div>
            </div>
        </div>

        <!-- Event Extraction Section -->
        <div class="section">
            <h3>üìä Event Extraction</h3>
            <button onclick="extractEvents()" class="success">üì• Extract Events</button>
            <button onclick="extractUsers()" class="success">üë• Extract Users</button>
            <button onclick="testConnection()" >üîç Test Connection</button>
        </div>

        <!-- Status Display -->
        <div id="status"></div>

        <!-- Logs Section -->
        <div class="section">
            <h3>üìù Activity Logs</h3>
            <div id="logs"></div>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
    </div>

    <!-- Load WebSDK Dependencies -->
    <script src="/websdk/demo/codebase/webVideoCtrl.js"></script>
    <script src="/websdk/demo/codebase/jsVideoPlugin-1.0.0.min.js"></script>

    <script>
        let g_iWndIndex = 0;
        let isConnected = false;
        let deviceIdentify = '';

        // Initialize WebSDK Plugin
        function initializeWebSDK() {
            logMessage('üîß Initializing WebSDK plugin...');
            
            WebVideoCtrl.I_InitPlugin({
                bWndFull: true,
                iWndowType: 1,
                cbSelWnd: function (xmlDoc) {
                    g_iWndIndex = parseInt($(xmlDoc).find("SelectWnd").eq(0).text(), 10);
                    logMessage(`üì∫ Selected window index: ${g_iWndIndex}`);
                },
                cbDoubleClickWnd: function (iWndIndex, bFullScreen) {
                    logMessage(`üì∫ Window ${iWndIndex} ${bFullScreen ? 'zoomed' : 'restored'}`);
                },
                cbEvent: function (iEventType, iParam1, iParam2) {
                    if (2 === iEventType) {
                        logMessage(`üì∫ Window ${iParam1} playback finished`);
                    } else if (-1 === iEventType) {
                        logMessage(`‚ùå Device ${iParam1} network error`);
                    }
                },
                cbInitPluginComplete: function () {
                    logMessage('‚úÖ WebSDK plugin initialization complete');
                    WebVideoCtrl.I_InsertOBJECTPlugin("divPlugin").then(() => {
                        logMessage('‚úÖ Plugin container inserted successfully');
                        showStatus('WebSDK plugin initialized successfully', 'success');
                    }, () => {
                        logMessage('‚ùå Failed to insert plugin container');
                        showStatus('Plugin initialization failed. Please install HCWebSDKPlugin.exe', 'error');
                    });
                }
            });
        }

        // Connect to device
        function connectDevice() {
            const ip = document.getElementById('deviceIP').value;
            const port = document.getElementById('devicePort').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!ip || !port || !username || !password) {
                showStatus('Please fill in all connection fields', 'error');
                return;
            }

            deviceIdentify = `${ip}_${port}`;
            logMessage(`üîë Attempting to connect to ${deviceIdentify}...`);

            WebVideoCtrl.I_Login(ip, 1, port, username, password, {
                timeout: 10000,
                success: function (xmlDoc) {
                    isConnected = true;
                    logMessage(`‚úÖ Successfully connected to ${deviceIdentify}`);
                    showStatus(`Connected to device ${deviceIdentify}`, 'success');
                    
                    // Notify the server about successful login
                    fetch('/device/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip, port, username, password })
                    }).catch(err => logMessage(`‚ö†Ô∏è Server notification failed: ${err.message}`));
                },
                error: function (oError) {
                    isConnected = false;
                    logMessage(`‚ùå Connection failed: ${oError.errorMsg || oError.errorCode}`);
                    showStatus(`Connection failed: ${oError.errorMsg || 'Unknown error'}`, 'error');
                }
            });
        }

        // Disconnect from device
        function disconnectDevice() {
            if (!isConnected || !deviceIdentify) {
                showStatus('No active connection to disconnect', 'error');
                return;
            }

            WebVideoCtrl.I_Logout(deviceIdentify).then(() => {
                isConnected = false;
                logMessage(`üö™ Successfully disconnected from ${deviceIdentify}`);
                showStatus(`Disconnected from device ${deviceIdentify}`, 'success');
                
                // Notify the server about logout
                fetch('/device/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).catch(err => logMessage(`‚ö†Ô∏è Server notification failed: ${err.message}`));
            }).catch(() => {
                logMessage(`‚ùå Disconnect failed for ${deviceIdentify}`);
                showStatus('Disconnect failed', 'error');
            });
        }

        // Get device information
        function getDeviceInfo() {
            if (!isConnected || !deviceIdentify) {
                showStatus('Please connect to device first', 'error');
                return;
            }

            WebVideoCtrl.I_GetDeviceInfo(deviceIdentify, {
                success: function (xmlDoc) {
                    const deviceInfo = {
                        name: $(xmlDoc).find("deviceName").eq(0).text(),
                        id: $(xmlDoc).find("deviceID").eq(0).text(),
                        model: $(xmlDoc).find("model").eq(0).text(),
                        serial: $(xmlDoc).find("serialNumber").eq(0).text(),
                        mac: $(xmlDoc).find("macAddress").eq(0).text(),
                        firmware: $(xmlDoc).find("firmwareVersion").eq(0).text()
                    };
                    
                    logMessage(`üìã Device Info Retrieved:`);
                    logMessage(`   Name: ${deviceInfo.name}`);
                    logMessage(`   ID: ${deviceInfo.id}`);
                    logMessage(`   Model: ${deviceInfo.model}`);
                    logMessage(`   Serial: ${deviceInfo.serial}`);
                    logMessage(`   MAC: ${deviceInfo.mac}`);
                    logMessage(`   Firmware: ${deviceInfo.firmware}`);
                    
                    showStatus('Device information retrieved successfully', 'success');
                },
                error: function (oError) {
                    logMessage(`‚ùå Failed to get device info: ${oError.errorMsg || oError.errorCode}`);
                    showStatus('Failed to retrieve device information', 'error');
                }
            });
        }

        // Extract events from device using actual WebSDK calls
        function extractEvents() {
            if (!isConnected || !deviceIdentify) {
                showStatus('Please connect to device first', 'error');
                return;
            }

            logMessage('üì• Extracting attendance events using WebSDK...');
            
            // For access control devices, we would typically need to:
            // 1. Get channel information
            // 2. Search for attendance events
            // 3. Extract event data
            
            // Since FC4349999 is an access control terminal, we'll use 
            // the HTTP requests through WebSDK for now
            const today = new Date().toISOString().split('T')[0];
            const startTime = `${today} 00:00:00`;
            const endTime = `${today} 23:59:59`;
            
            // For now, simulate the extraction and notify the server
            fetch('/device/extract')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        logMessage(`‚úÖ Extracted ${data.events.length} events:`);
                        data.events.forEach(event => {
                            logMessage(`   üìã ${event.employeeName} (${event.employeeId}) - ${event.eventType} at ${event.timestamp}`);
                        });
                        showStatus(`Successfully extracted ${data.events.length} events`, 'success');
                    } else {
                        logMessage(`‚ùå Event extraction failed: ${data.message}`);
                        showStatus('Event extraction failed', 'error');
                    }
                })
                .catch(error => {
                    logMessage(`‚ùå Event extraction error: ${error.message}`);
                    showStatus('Event extraction error', 'error');
                });
        }

        // Extract users from device
        function extractUsers() {
            logMessage('üë• Extracting user information...');
            
            fetch('/device/extract')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        logMessage(`‚úÖ Extracted ${data.users.length} users:`);
                        data.users.forEach(user => {
                            logMessage(`   üë§ ${user.name} (ID: ${user.id}, Card: ${user.cardNumber})`);
                        });
                        showStatus(`Successfully extracted ${data.users.length} users`, 'success');
                    } else {
                        logMessage(`‚ùå User extraction failed: ${data.message}`);
                        showStatus('User extraction failed', 'error');
                    }
                })
                .catch(error => {
                    logMessage(`‚ùå User extraction error: ${error.message}`);
                    showStatus('User extraction error', 'error');
                });
        }

        // Test connection
        function testConnection() {
            logMessage('üîç Testing server connection...');
            
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    logMessage(`‚úÖ Server Status: ${data.status}`);
                    logMessage(`üì° Service: ${data.service}`);
                    logMessage(`‚è∞ Timestamp: ${data.timestamp}`);
                    showStatus('Server connection successful', 'success');
                })
                .catch(error => {
                    logMessage(`‚ùå Server connection error: ${error.message}`);
                    showStatus('Server connection failed', 'error');
                });
        }

        // Helper functions
        function logMessage(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            logMessage('üöÄ WebSDK Interface loaded');
            logMessage('üìã Ready to connect to Hikvision device FC4349999');
            
            // Initialize WebSDK after page load
            setTimeout(() => {
                initializeWebSDK();
            }, 1000);
        });
    </script>
</body>
</html>